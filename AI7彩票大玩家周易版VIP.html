<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>彩票大玩家</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin: 0; padding: 0; font-size: 17px; }
    .container { 
      max-width: 520px; 
      margin: 40px auto; 
      background: rgba(255,255,255,0.9); 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      padding: 36px 20px; 
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    h1 { text-align: center; color: #2d8cf0; letter-spacing: 2px; margin-bottom: 18px; }
    .game-mode { display: flex; justify-content: center; margin-bottom: 24px; gap: 10px; }
    .game-mode button { margin: 0 8px; padding: 8px 24px; border: none; border-radius: 8px; background: #e6e6e6; color: #333; font-size: 16px; cursor: pointer; transition: background 0.2s; }
    .game-mode button.active { background: #2d8cf0; color: #fff; }
    .section { margin-bottom: 22px; }
    .balls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .ball { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; cursor: pointer; border: 2px solid #eee; background: #f7f7f7; transition: all 0.3s ease; }
    .ball.selected { background: #2d8cf0; color: #fff; border: 2px solid #2d8cf0; }
    .ball.red { background: #ffeaea; color: #ff4d4f; border: 2px solid #ffb3b3; }
    .ball.blue { background: #e6f0ff; color: #1890ff; border: 2px solid #91caff; }
    .ball.gray { background: #eee; color: #aaa; border: 2px solid #aaa; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #2d8cf0;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
      margin: 5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .actions button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .actions button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .actions input[type=number] { height: 30px; font-size: 15px; border-radius: 5px; border: 1px solid #d9d9d9; padding: 0 6px; margin: 0 2px; }
    .actions select { height: 32px; font-size: 15px; border-radius: 5px; border: 1px solid #d9d9d9; margin-right: 2px; }
    .result { background: #f0f9ff; border-left: 4px solid #2d8cf0; padding: 12px 16px; border-radius: 6px; margin-top: 16px; }
    .lottery-balls { display: flex; gap: 8px; margin-top: 8px; }
    .lottery-balls .ball { cursor: default; }
    .open-area {
      background: linear-gradient(135deg, rgba(255,251,230,0.9) 0%, rgba(255,229,143,0.8) 100%);
      box-shadow: 0 4px 20px rgba(255,215,0,0.2);
      border-radius: 10px;
      border: 1.5px solid gold;
      margin-bottom: 28px;
      padding: 14px 10px 10px 10px;
      text-align: center;
      animation: openfade 1s;
      font-size: 18px;
    }
    .gold-animate { border: 2px solid gold !important; box-shadow: 0 0 10px #ffd70088; animation: goldflash 1.2s linear infinite alternate; }
    @keyframes goldflash {
      0% { box-shadow: 0 0 10px #ffd70088, 0 0 0 #fff0; }
      100% { box-shadow: 0 0 24px #ffd700cc, 0 0 8px #fffbe6; }
    }
    @keyframes openfade {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }
    .section .number-line { margin: 10px 0 14px 0; padding: 8px 10px; border-radius: 10px; font-size: 17px; line-height: 2.1; transition: box-shadow 0.2s; }
    .section .number-line:not(:last-child) { margin-bottom: 14px; }
    .section .number-line.winning {
      background: linear-gradient(135deg, rgba(246,255,237,0.9) 0%, rgba(183,235,143,0.8) 100%);
      box-shadow: 0 4px 12px rgba(82,196,26,0.2);
      border: 2px solid #52c41a;
      box-shadow: 0 0 8px #b7eb8f;
      background: #f6ffed;
      color: #222;
    }
    .section .number-line.losing { color: #aaa; background: #fafafa; border: 1px solid #eee; }
    @media (max-width: 600px) {
      .container { padding: 20px 10px; max-width: 100%; margin: 20px auto; }
      .game-mode { flex-wrap: wrap; justify-content: center; }
      .game-mode button { margin: 4px; padding: 6px 12px; font-size: 14px; }
      .actions { justify-content: center; gap: 6px; }
      .actions button {
        padding: 8px 16px;
        font-size: 15px;
        min-width: 80px;
      }
      .actions select { height: 30px; font-size: 14px; }
      .actions input[type=number] { height: 28px; font-size: 14px; }
      .balls { gap: 4px; }
      .ball { width: 30px; height: 30px; font-size: 14px; }
      .open-area { font-size: 15px; }
      .section .number-line { font-size: 15px; padding: 6px 4px; }
    }
    .ball:hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="font-size:2.2em;letter-spacing:3px;display:flex;align-items:center;justify-content:center;">
      <span style="font-size:1.2em;margin-right:10px;">🎯</span>彩票大玩家
    </h1>
    <div class="game-mode">
      <button id="mode-ssq" class="active">双色球</button>
      <button id="mode-dlt">大乐透</button>
    </div>
    <div id="game-area"></div>
  </div>
  <div style="text-align:center;color:#888;font-size:13px;margin:30px 0 10px 0;">
    版权所有人：<a href="weixin://contacts/profile/xthend" style="color:#2d8cf0;text-decoration:underline;" target="_blank">多宝爸</a>
  </div>
  <script>
    // 游戏配置
    const configs = {
      ssq: {
        name: '双色球',
        red: { count: 6, max: 33 },
        blue: { count: 1, max: 16 },
        prize: [
          { matchRed: 6, matchBlue: 1, name: '一等奖', bonus: '1000万' },
          { matchRed: 6, matchBlue: 0, name: '二等奖', bonus: '150万' },
          { matchRed: 5, matchBlue: 1, name: '三等奖', bonus: '3000元' },
          { matchRed: 5, matchBlue: 0, name: '四等奖', bonus: '200元' },
          { matchRed: 4, matchBlue: 1, name: '四等奖', bonus: '200元' },
          { matchRed: 4, matchBlue: 0, name: '五等奖', bonus: '10元' },
          { matchRed: 3, matchBlue: 1, name: '五等奖', bonus: '10元' },
          { matchRed: 2, matchBlue: 1, name: '六等奖', bonus: '5元' },
          { matchRed: 1, matchBlue: 1, name: '六等奖', bonus: '5元' },
          { matchRed: 0, matchBlue: 1, name: '六等奖', bonus: '5元' },
        ]
      },
      dlt: {
        name: '大乐透',
        red: { count: 5, max: 35 },
        blue: { count: 2, max: 12 },
        prize: [
          { matchRed: 5, matchBlue: 2, name: '一等奖', bonus: '1000万' },
          { matchRed: 5, matchBlue: 1, name: '二等奖', bonus: '100万' },
          { matchRed: 5, matchBlue: 0, name: '三等奖', bonus: '10000元' },
          { matchRed: 4, matchBlue: 2, name: '四等奖', bonus: '3000元' },
          { matchRed: 4, matchBlue: 1, name: '五等奖', bonus: '300元' },
          { matchRed: 3, matchBlue: 2, name: '六等奖', bonus: '200元' },
          { matchRed: 4, matchBlue: 0, name: '七等奖', bonus: '100元' },
          { matchRed: 3, matchBlue: 1, name: '八等奖', bonus: '15元' },
          { matchRed: 2, matchBlue: 2, name: '八等奖', bonus: '15元' },
          { matchRed: 3, matchBlue: 0, name: '九等奖', bonus: '5元' },
          { matchRed: 1, matchBlue: 2, name: '九等奖', bonus: '5元' },
          { matchRed: 2, matchBlue: 1, name: '九等奖', bonus: '5元' },
          { matchRed: 0, matchBlue: 2, name: '九等奖', bonus: '5元' },
        ]
      }
    };

    let mode = 'ssq';
    let userRed = [], userBlue = [];
    let lotteryRed = [], lotteryBlue = [];
    let result = null;
    let betCount = 1; // 注数，默认1
    let userNumbers = []; // 多注选号
    let lotteryNumbers = []; // 多注开奖号码
    let results = []; // 多注结果
    let jackpotNumbers = null;
    let hasDrawed = false; // 是否已经开奖过
    let luckyTaskId = 0;

    function renderGame() {
      const cfg = configs[mode];
      const area = document.getElementById('game-area');
      area.innerHTML = '';
      // 选号区
      const section1 = document.createElement('div');
      section1.className = 'section';
      section1.innerHTML = `<b>请选择${cfg.red.count}个红球</b>（1-${cfg.red.max}）`;
      const ballsRed = document.createElement('div');
      ballsRed.className = 'balls';
      for (let i = 1; i <= cfg.red.max; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball' + (userRed.includes(i) ? ' selected red' : '');
        ball.textContent = i < 10 ? '0' + i : i;
        ball.onclick = () => {
          if (userRed.includes(i)) {
            userRed = userRed.filter(x => x !== i);
          } else {
            if (userRed.length < cfg.red.count) userRed.push(i);
          }
          renderGame();
        };
        ballsRed.appendChild(ball);
      }
      section1.appendChild(ballsRed);
      area.appendChild(section1);
      // 蓝球/后区
      const section2 = document.createElement('div');
      section2.className = 'section';
      section2.innerHTML = `<b>请选择${cfg.blue.count}个${mode==='ssq'?'蓝球':'后区'}</b>（1-${cfg.blue.max}）`;
      const ballsBlue = document.createElement('div');
      ballsBlue.className = 'balls';
      for (let i = 1; i <= cfg.blue.max; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball' + (userBlue.includes(i) ? ' selected blue' : '');
        ball.textContent = i < 10 ? '0' + i : i;
        ball.onclick = () => {
          if (userBlue.includes(i)) {
            userBlue = userBlue.filter(x => x !== i);
          } else {
            if (userBlue.length < cfg.blue.count) userBlue.push(i);
          }
          renderGame();
        };
        ballsBlue.appendChild(ball);
      }
      section2.appendChild(ballsBlue);
      area.appendChild(section2);
      // 操作区
      const actions = document.createElement('div');
      actions.className = 'actions';
      // 注数选择器
      const betSelect = document.createElement('select');
      [1,5,20,100,500,1000].forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = `${n}注`;
        if (betCount === n) opt.selected = true;
        betSelect.appendChild(opt);
      });
      betSelect.onchange = e => {
        betCount = parseInt(e.target.value);
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(betSelect);
      // 随机选号
      const btnRand = document.createElement('button');
      btnRand.textContent = '随机选号';
      btnRand.onclick = () => {
        // 只替换机选号码，保留手动加的号码
        let manualNums = userNumbers.filter(num => num.manual);
        let autoCount = betCount - manualNums.length;
        let autoNums = [];
        for (let i = 0; i < autoCount; i++) {
          autoNums.push({
            red: randomBalls(cfg.red.max, cfg.red.count),
            blue: randomBalls(cfg.blue.max, cfg.blue.count)
          });
        }
        userNumbers = manualNums.concat(autoNums);
        if (userNumbers.length > 0) {
          userRed = userNumbers[0].red.slice();
          userBlue = userNumbers[0].blue.slice();
        }
        result = null;
        results = [];
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(btnRand);
      // 清空选号
      const btnClear = document.createElement('button');
      btnClear.textContent = '清空选号';
      btnClear.onclick = () => {
        userRed = [];
        userBlue = [];
        userNumbers = [];
        result = null;
        results = [];
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(btnClear);
      // 手动加一注
      const btnManualAdd = document.createElement('button');
      btnManualAdd.textContent = '手动加一注';
      btnManualAdd.disabled = !(userRed.length === cfg.red.count && userBlue.length === cfg.blue.count);
      btnManualAdd.onclick = () => {
        userNumbers.push({red: userRed.slice(), blue: userBlue.slice(), manual: true});
        userRed = [];
        userBlue = [];
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(btnManualAdd);
      // 开奖
      const btnDraw = document.createElement('button');
      btnDraw.textContent = '开奖';
      let valid = userNumbers.length > 0 && userNumbers.every(num => num.red.length === cfg.red.count && num.blue.length === cfg.blue.count);
      btnDraw.disabled = !valid;
      btnDraw.onclick = () => {
        if (!hasDrawed) {
          // 第一次开奖，userNumbers为空时用选号区号码
          if (userNumbers.length === 0) {
            userNumbers = [{red: userRed.slice(), blue: userBlue.slice()}];
          }
        } else {
          // 后续开奖只随机非手动号码
          let manualNums = userNumbers.filter(num => num.manual);
          let autoCount = betCount - manualNums.length;
          let autoNums = [];
          for (let i = 0; i < autoCount; i++) {
            autoNums.push({
              red: randomBalls(cfg.red.max, cfg.red.count),
              blue: randomBalls(cfg.blue.max, cfg.blue.count)
            });
          }
          userNumbers = manualNums.concat(autoNums);
        }
        // 只生成一组开奖号码
        const lRed = randomBalls(cfg.red.max, cfg.red.count);
        const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
        lotteryNumbers = [{red: lRed, blue: lBlue}];
        results = [];
        for (let i = 0; i < userNumbers.length; i++) {
          results.push(checkPrize(userNumbers[i].red, userNumbers[i].blue, lRed, lBlue));
        }
        renderGame();
        hasDrawed = true;
      };
      actions.appendChild(btnDraw);
      // 守号再开奖
      const btnKeep = document.createElement('button');
      btnKeep.textContent = '守号再开奖';
      btnKeep.disabled = !valid;
      btnKeep.onclick = () => {
        // 只生成一组新开奖号码，用户号码不变
        const lRed = randomBalls(cfg.red.max, cfg.red.count);
        const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
        lotteryNumbers = [{red: lRed, blue: lBlue}];
        results = [];
        for (let i = 0; i < betCount; i++) {
          results.push(checkPrize(userNumbers[i].red, userNumbers[i].blue, lRed, lBlue));
        }
        renderGame();
      };
      actions.appendChild(btnKeep);

      // 测试开奖
      const testInput = document.createElement('input');
      testInput.type = 'number';
      testInput.min = 1;
      testInput.max = 100000;
      testInput.value = 100000;
      testInput.style.width = '70px';
      testInput.style.marginLeft = '8px';
      testInput.title = '最大开奖次数';
      actions.appendChild(testInput);

      const btnTest = document.createElement('button');
      btnTest.textContent = '测试开奖';
      btnTest.disabled = !valid;
      btnTest.onclick = () => {
        const maxTimes = Math.max(1, Math.min(100000, parseInt(testInput.value)));
        let totalCost = 0;
        let totalWin = 0;
        let times = 0;
        let jackpotHit = false;
        let jackpotIdx = -1;
        let jackpotName = '';
        const cfg = configs[mode];
        // 奖项统计（合并同名奖项）
        const prizeCount = {};
        cfg.prize.forEach(p => { prizeCount[p.name] = 0; });
        // 多注测试
        while (times < maxTimes && !jackpotHit) {
          const lRed = randomBalls(cfg.red.max, cfg.red.count);
          const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
          totalCost += betCount * 2; // 每次开奖所有注都花钱
          for (let i = 0; i < betCount; i++) {
            const user = userNumbers[i];
            const r = checkPrize(user.red, user.blue, lRed, lBlue);
            if (r && r.bonus) {
              // 解析奖金
              let bonus = 0;
              if (r.bonus.includes('万')) {
                bonus = parseFloat(r.bonus) * 10000;
              } else if (r.bonus.includes('元')) {
                bonus = parseFloat(r.bonus);
              }
              totalWin += bonus;
              if (prizeCount[r.name] !== undefined) prizeCount[r.name]++;
              if (r.name === cfg.prize[0].name) {
                jackpotHit = true;
                jackpotIdx = times + 1;
                jackpotName = r.name;
                jackpotNumbers = {red: lRed.slice(), blue: lBlue.slice()};
                break;
              }
            }
          }
          times++;
        }
        const profit = totalWin - totalCost;
        // 结构化高亮内容
        let highlight = `<div style='margin-bottom:8px;'><b>开奖次数：</b><span style='color:#2d8cf0;font-weight:bold;'>${times}</span>，<b>注数：</b>${betCount}</div>`;
        highlight += `<div style='margin-bottom:8px;'><b>总花费：</b><span style='color:#fa541c;font-weight:bold;'>${totalCost}元</span></div>`;
        highlight += `<div style='margin-bottom:8px;'><b>中奖金额：</b><span style='color:#52c41a;font-weight:bold;'>${totalWin}元</span></div>`;
        highlight += `<div style='margin-bottom:8px;'><b>盈亏：</b><span style='color:${profit>=0?'#52c41a':'#fa541c'};font-weight:bold;'>${profit>=0?'+'+profit:profit}元</span></div>`;
        // 奖项统计
        const shown = new Set();
        let prizeMsg = '';
        for (const p of cfg.prize) {
          if (!shown.has(p.name) && prizeCount[p.name]) {
            prizeMsg += `<div><b>${p.name}：</b><span style='color:#2d8cf0;font-weight:bold;'>${prizeCount[p.name]}</span> 次</div>`;
            shown.add(p.name);
          }
        }
        if (prizeMsg) highlight += `<div style='margin:10px 0 8px 0;'><b>各奖项中奖次数：</b>${prizeMsg}</div>`;
        if (jackpotHit) {
          highlight += `<div style='margin:10px 0 8px 0;'><b>头奖出现：</b>第<span style='color:#faad14;font-weight:bold;'>${jackpotIdx}</span>次开奖，<b>奖项：</b><span style='color:#faad14;font-weight:bold;'>${jackpotName}</span></div>`;
        } else {
          highlight += `<div style='margin:10px 0 8px 0;'><b>头奖：</b><span style='color:#aaa;'>未中头奖</span></div>`;
        }
        showTestResult('', jackpotHit ? jackpotNumbers : null, highlight);
      };
      actions.appendChild(btnTest);

      // 幸运号码组
      const btnLucky = document.createElement('button');
      btnLucky.textContent = '幸运号码组';
      btnLucky.style.background = 'linear-gradient(90deg,#faad14,#52c41a,#1890ff)';
      btnLucky.style.color = '#fff';
      btnLucky.style.fontWeight = 'bold';
      btnLucky.onclick = () => {
        const thisTaskId = Date.now() + Math.random();
        luckyTaskId = thisTaskId;
        const cfg = configs[mode];
        // 1. 随机1000注
        let luckyNumbers = [];
        for (let i = 0; i < 1000; i++) {
          luckyNumbers.push({
            red: randomBalls(cfg.red.max, cfg.red.count),
            blue: randomBalls(cfg.blue.max, cfg.blue.count)
          });
        }
        // 弹窗+进度条
        let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>幸运号码组</div>`;
        html += `<div style='font-size:15px;color:#888;margin-bottom:10px;'>本功能将随机生成1000组号码，分别进行5次共50万次开奖，统计中奖金额最高的前5组号码。</div>`;
        html += `<div id='lucky-progress-text' style='margin-bottom:4px;font-size:15px;color:#888;'>正在计算幸运号码组：已完成 0%（0/500000）</div>`;
        html += `<div id='lucky-progress' style='width:100%;height:18px;background:#eee;border-radius:8px;overflow:hidden;margin-bottom:16px;position:relative;'><div id='lucky-bar' style='height:100%;width:0%;background:linear-gradient(90deg,#faad14,#52c41a,#1890ff);transition:width 0.2s;position:absolute;left:0;top:0;'></div><div id='lucky-bar-text' style='position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333;font-weight:bold;pointer-events:none;'>0%</div></div>`;
        showTestResult('', null, html, () => { luckyTaskId = 0; });
        // 2. 分批异步计算
        let winAmounts = Array(1000).fill(0);
        let group = 0, t = 0;
        const totalGroups = 5, totalTimes = 100000;
        const totalSteps = totalGroups * totalTimes;
        let step = 0;
        function processBatch() {
          if (luckyTaskId !== thisTaskId) return;
          let batch = 500; // 每批处理500次开奖
          let processed = 0;
          while (group < totalGroups && processed < batch) {
            const lRed = randomBalls(cfg.red.max, cfg.red.count);
            const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
            for (let i = 0; i < 1000; i++) {
              const r = checkPrize(luckyNumbers[i].red, luckyNumbers[i].blue, lRed, lBlue);
              if (r && r.bonus) {
                let bonus = 0;
                if (r.bonus.includes('万')) {
                  bonus = parseFloat(r.bonus) * 10000;
                } else if (r.bonus.includes('元')) {
                  bonus = parseFloat(r.bonus);
                }
                winAmounts[i] += bonus;
              }
            }
            t++;
            step++;
            processed++;
            if (t >= totalTimes) { t = 0; group++; }
          }
          // 更新进度条
          const percent = Math.floor(step / totalSteps * 100);
          const bar = document.getElementById('lucky-bar');
          const barText = document.getElementById('lucky-bar-text');
          const progText = document.getElementById('lucky-progress-text');
          if (bar) bar.style.width = percent + '%';
          if (barText) barText.textContent = percent + '%';
          if (progText) progText.textContent = `正在计算幸运号码组：已完成 ${percent}%（${step}/${totalSteps}）`;
          if (group < totalGroups) {
            setTimeout(processBatch, 0);
          } else if (luckyTaskId === thisTaskId) {
            // 3. 找出中奖金额最高的前5个号码
            let topIdx = winAmounts.map((amount, idx) => ({amount, idx}))
              .sort((a,b)=>b.amount-a.amount)
              .slice(0,5)
              .map(x=>x.idx);
            // 4. 展示
            let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>幸运号码组（随机1000注，5×10万次开奖，奖金前5名）：</div>`;
            topIdx.forEach((idx,rank) => {
              const num = luckyNumbers[idx];
              const amount = winAmounts[idx];
              const redText = num.red.slice().sort((a,b)=>a-b).map(n => `<span style='color:#ff4d4f;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
              const blueText = num.blue.slice().sort((a,b)=>a-b).map(n => `<span style='color:#1890ff;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
              html += `<div style='margin:12px 0;padding:10px 18px;border-radius:12px;background:linear-gradient(90deg,#faad14,#52c41a,#1890ff);color:#fff;box-shadow:0 2px 12px #0001;display:flex;align-items:center;'>`;
              html += `<span style='font-size:20px;font-weight:bold;margin-right:18px;'>NO.${rank+1}</span> <span style='font-size:17px;'>${redText} + ${blueText}</span> <span style='margin-left:auto;font-size:16px;'>中奖金额：${amount}元</span>`;
              html += `</div>`;
            });
            // 更新弹窗内容
            const contentDiv = document.getElementById('lucky-content');
            if (contentDiv) contentDiv.innerHTML = html;
          }
        }
        processBatch();
      };
      actions.appendChild(btnLucky);

      // 周易出号
      const btnYijing = document.createElement('button');
      btnYijing.textContent = '周易出号';
      btnYijing.style.background = 'linear-gradient(90deg,#722ed1,#1890ff)';
      btnYijing.style.color = '#fff';
      btnYijing.style.fontWeight = 'bold';
      btnYijing.onclick = () => {
        showYijingDialog();
      };
      actions.appendChild(btnYijing);

      // 碰撞出号
      const btnCollision = document.createElement('button');
      btnCollision.textContent = '碰撞出号';
      btnCollision.style.background = 'linear-gradient(90deg,#fa541c,#faad14)';
      btnCollision.style.color = '#fff';
      btnCollision.style.fontWeight = 'bold';
      btnCollision.onclick = () => {
        btnCollision.disabled = true;
        let collisionCount = 0;
        const cfg = configs[mode];
        const numMap = new Map();
        const totalRounds = 100;
        // 弹窗简介和进度条
        let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>碰撞出号（100轮，每轮2万注，统计出现最多的号码）</div>`;
        html += `<div style='font-size:15px;color:#888;margin-bottom:10px;'>本功能用于模拟大规模随机选号，统计在200万注中出现次数最多的号码。<br>碰撞完成后将展示出现最多的号码及其出现次数。</div>`;
        html += `<div id='collision-progress-text' style='margin-bottom:4px;font-size:15px;color:#888;'>已完成 0%（0/100）</div>`;
        html += `<div id='collision-progress' style='width:100%;height:18px;background:#eee;border-radius:8px;overflow:hidden;margin-bottom:16px;position:relative;'><div id='collision-bar' style='height:100%;width:0%;background:linear-gradient(90deg,#fa541c,#faad14);transition:width 0.2s;position:absolute;left:0;top:0;'></div><div id='collision-bar-text' style='position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333;font-weight:bold;pointer-events:none;'>0%</div></div>`;
        html += `<div id='collision-result'></div>`;
        showTestResult('', null, html);

        function genNums() {
          let arr = [];
          for (let i = 0; i < 10000; i++) {
            arr.push({
              red: randomBalls(cfg.red.max, cfg.red.count),
              blue: randomBalls(cfg.blue.max, cfg.blue.count)
            });
          }
          return arr;
        }
        function numKey(num) {
          return num.red.slice().sort((a,b)=>a-b).join(',') + '|' + num.blue.slice().sort((a,b)=>a-b).join(',');
        }
        function updateProgress() {
          const percent = Math.floor(collisionCount / totalRounds * 100);
          const bar = document.getElementById('collision-bar');
          const barText = document.getElementById('collision-bar-text');
          const progText = document.getElementById('collision-progress-text');
          if (bar) bar.style.width = percent + '%';
          if (barText) barText.textContent = percent + '%';
          if (progText) progText.textContent = `已完成 ${percent}%（${collisionCount}/${totalRounds}）`;
        }
        function doCollision() {
          collisionCount++;
          const groupA = genNums();
          const groupB = genNums();
          [...groupA, ...groupB].forEach(num => {
            const key = numKey(num);
            numMap.set(key, (numMap.get(key) || 0) + 1);
          });
          updateProgress();
          if (collisionCount < totalRounds) {
            setTimeout(doCollision, 0);
          } else {
            // 统计出现最多的号码
            let maxKey = '';
            let maxCount = 0;
            for (let [key, count] of numMap.entries()) {
              if (count > maxCount) {
                maxCount = count;
                maxKey = key;
              }
            }
            // 解析号码
            const [redStr, blueStr] = maxKey.split('|');
            const redArr = redStr.split(',').map(x=>parseInt(x));
            const blueArr = blueStr.split(',').map(x=>parseInt(x));
            let redHtml = redArr.map(n=>`<span style='color:#ff4d4f;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
            let blueHtml = blueArr.map(n=>`<span style='color:#1890ff;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
            let resultHtml = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>碰撞统计完成！</div>`;
            resultHtml += `<div style='margin-bottom:8px;'><b>碰撞轮数：</b><span style='color:#2d8cf0;font-weight:bold;'>${totalRounds}</span></div>`;
            resultHtml += `<div style='margin-bottom:8px;'><b>出现最多的号码：</b>${redHtml} + ${blueHtml}</div>`;
            resultHtml += `<div style='margin-bottom:8px;'><b>出现次数：</b><span style='color:#fa541c;font-weight:bold;'>${maxCount}</span> 次</div>`;
            const resultDiv = document.getElementById('collision-result');
            if (resultDiv) resultDiv.innerHTML = resultHtml;
            btnCollision.disabled = false;
          }
        }
        doCollision();
      };
      actions.appendChild(btnCollision);

      area.appendChild(actions);
      // 开奖区（始终显示）
      const openDiv = document.createElement('div');
      openDiv.className = 'open-area';
      openDiv.innerHTML = `<b>开奖号码：</b>`;
      let lot = (lotteryNumbers && lotteryNumbers[0]) ? lotteryNumbers[0] : null;
      const ballsDiv = document.createElement('div');
      ballsDiv.className = 'lottery-balls';
      if (lot) {
        lot.red.slice().sort((a,b)=>a-b).forEach(n => {
          const b = document.createElement('div');
          b.className = 'ball gold-animate red';
          b.textContent = n < 10 ? '0'+n : n;
          ballsDiv.appendChild(b);
        });
        lot.blue.slice().sort((a,b)=>a-b).forEach(n => {
          const b = document.createElement('div');
          b.className = 'ball gold-animate blue';
          b.textContent = n < 10 ? '0'+n : n;
          ballsDiv.appendChild(b);
        });
      } else {
        // 未开奖时显示空球或提示
        for (let i = 0; i < cfg.red.count; i++) {
          const b = document.createElement('div');
          b.className = 'ball red';
          b.textContent = '--';
          ballsDiv.appendChild(b);
        }
        for (let i = 0; i < cfg.blue.count; i++) {
          const b = document.createElement('div');
          b.className = 'ball blue';
          b.textContent = '--';
          ballsDiv.appendChild(b);
        }
      }
      openDiv.appendChild(ballsDiv);
      area.appendChild(openDiv);

      // 已选号码展示（含中奖结果）
      if (userNumbers.length > 0) {
        const multiDiv = document.createElement('div');
        multiDiv.className = 'section';
        multiDiv.innerHTML = '<b>已选号码：</b>';
        userNumbers.forEach((num, idx) => {
          const line = document.createElement('div');
          line.className = 'number-line';
          // 注号前缀，固定宽度
          const idxSpan = document.createElement('span');
          idxSpan.textContent = `第${idx+1}注：`;
          idxSpan.style.display = 'inline-block';
          idxSpan.style.minWidth = '60px';
          line.appendChild(idxSpan);
          // 手动标志
          if (num.manual) {
            const tag = document.createElement('span');
            tag.textContent = '手动';
            tag.style.background = '#faad14';
            tag.style.color = '#fff';
            tag.style.fontSize = '13px';
            tag.style.borderRadius = '6px';
            tag.style.padding = '2px 8px';
            tag.style.marginRight = '8px';
            tag.style.marginLeft = '2px';
            tag.style.fontWeight = 'bold';
            line.appendChild(tag);
          }
          // 只用文本显示号码，红区红字，蓝区蓝字
          const redText = num.red.slice().sort((a,b)=>a-b).map(n => (n < 10 ? '0'+n : n)).join(' ');
          const blueText = num.blue.slice().sort((a,b)=>a-b).map(n => (n < 10 ? '0'+n : n)).join(' ');
          const textSpan = document.createElement('span');
          textSpan.innerHTML = `<span style='color:#ff4d4f'>${redText}</span> + <span style='color:#1890ff'>${blueText}</span>`;
          textSpan.style.marginRight = '12px';
          textSpan.style.whiteSpace = 'nowrap';
          line.appendChild(textSpan);
          // 删除按钮
          const delBtn = document.createElement('button');
          delBtn.textContent = '删除';
          delBtn.style.marginLeft = '10px';
          delBtn.style.background = '#f5222d';
          delBtn.style.color = '#fff';
          delBtn.style.border = 'none';
          delBtn.style.borderRadius = '5px';
          delBtn.style.fontSize = '13px';
          delBtn.style.padding = '2px 10px';
          delBtn.style.cursor = 'pointer';
          delBtn.style.whiteSpace = 'nowrap';
          delBtn.onclick = () => {
            userNumbers.splice(idx, 1);
            hasDrawed = false;
            renderGame();
          };
          line.appendChild(delBtn);
          // 中奖结果
          let resultObj = results[idx];
          const resultSpan = document.createElement('span');
          resultSpan.innerHTML = `<b>中奖结果：</b> <span style='font-weight:bold;'>${resultObj ? (resultObj.name + (resultObj.bonus ? '（'+resultObj.bonus+'）' : '')) : ''}</span>`;
          resultSpan.style.whiteSpace = 'nowrap';
          line.appendChild(resultSpan);
          // 样式处理
          if (resultObj) {
            if (resultObj.name === '未中奖') {
              line.classList.add('losing');
            } else {
              line.classList.add('winning');
            }
          }
          multiDiv.appendChild(line);
        });
        area.appendChild(multiDiv);
      }

      // 多注开奖结果（已合并到已选号码区，移除原结果区）
    }

    function randomBalls(max, count) {
      const arr = Array.from({length: max}, (_,i)=>i+1);
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr.slice(0, count).sort((a,b)=>a-b);
    }

    function checkPrize(userRed, userBlue, lotteryRed, lotteryBlue) {
      const cfg = configs[mode];
      const matchRed = userRed.filter(n => lotteryRed.includes(n)).length;
      const matchBlue = userBlue.filter(n => lotteryBlue.includes(n)).length;
      for (const p of cfg.prize) {
        if (matchRed === p.matchRed && matchBlue === p.matchBlue) {
          return p;
        }
      }
      return { name: '未中奖', bonus: '' };
    }

    // 玩法切换
    document.getElementById('mode-ssq').onclick = () => {
      mode = 'ssq';
      userRed = [];
      userBlue = [];
      result = null;
      document.getElementById('mode-ssq').classList.add('active');
      document.getElementById('mode-dlt').classList.remove('active');
      renderGame();
    };
    document.getElementById('mode-dlt').onclick = () => {
      mode = 'dlt';
      userRed = [];
      userBlue = [];
      result = null;
      document.getElementById('mode-dlt').classList.add('active');
      document.getElementById('mode-ssq').classList.remove('active');
      renderGame();
    };

    // 测试开奖弹窗
    function showTestResult(msg, jackpotNumbers, highlight, onClose) {
      // 移除已有弹窗
      const old = document.getElementById('test-modal');
      if (old) old.remove();
      const modal = document.createElement('div');
      modal.id = 'test-modal';
      modal.style.position = 'fixed';
      modal.style.left = '0';
      modal.style.top = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.25)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '9999';
      const box = document.createElement('div');
      box.style.background = '#fff';
      box.style.borderRadius = '12px';
      box.style.padding = '28px 24px 18px 24px';
      box.style.minWidth = '320px';
      box.style.maxWidth = '90vw';
      box.style.boxShadow = '0 4px 32px #0002';
      box.style.fontSize = '17px';
      box.style.lineHeight = '2';
      // 内容区
      const contentDiv = document.createElement('div');
      contentDiv.id = 'lucky-content';
      contentDiv.innerHTML = highlight;
      if (jackpotNumbers) {
        let redStr = jackpotNumbers.red.sort((a,b)=>a-b).map(n=>`<span style='color:#ff4d4f;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
        let blueStr = jackpotNumbers.blue.sort((a,b)=>a-b).map(n=>`<span style='color:#1890ff;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
        const colorLine = `<div style='margin-top:8px;'><b>开奖号码：</b>${redStr} + ${blueStr}</div>`;
        contentDiv.innerHTML += colorLine;
      }
      box.appendChild(contentDiv);
      // 关闭按钮
      const btn = document.createElement('button');
      btn.textContent = '关闭';
      btn.style.marginTop = '18px';
      btn.style.padding = '6px 24px';
      btn.style.background = '#2d8cf0';
      btn.style.color = '#fff';
      btn.style.border = 'none';
      btn.style.borderRadius = '6px';
      btn.style.fontSize = '16px';
      btn.style.cursor = 'pointer';
      btn.onclick = () => {
        if (onClose) onClose();
        modal.remove();
      };
      box.appendChild(btn);
      modal.appendChild(box);
      document.body.appendChild(modal);
    }

    // 64卦表（简化版，卦辞和吉凶可补充完善）
    const yijingHexagrams = [
      {name:'乾', desc:'元亨利贞。', luck:'大吉', explain:'象征天，积极进取，万事顺利。'},
      {name:'坤', desc:'含弘光大，品物咸亨。', luck:'大吉', explain:'象征地，包容万物，顺势而为。'},
      {name:'屯', desc:'元亨，利贞，勿用有攸往，利建侯。', luck:'小吉', explain:'万事起头难，需耐心等待时机。'},
      {name:'蒙', desc:'亨。匪我求童蒙，童蒙求我。', luck:'中平', explain:'启蒙阶段，宜虚心学习。'},
      {name:'需', desc:'有孚，光亨，贞吉。', luck:'吉', explain:'等待时机，保持信心。'},
      {name:'讼', desc:'有孚窒惕，中吉，终凶。', luck:'凶', explain:'有争执，宜和为贵，慎防口舌。'},
      {name:'师', desc:'贞，丈人吉，无咎。', luck:'吉', explain:'有组织有纪律，依靠权威。'},
      {name:'比', desc:'吉。原筮，元永贞，无咎。', luck:'吉', explain:'团结协作，互相帮助。'},
      {name:'小畜', desc:'亨。密云不雨，自我西郊。', luck:'中平', explain:'积少成多，宜耐心积累。'},
      {name:'履', desc:'履虎尾，不咥人，亨。', luck:'吉', explain:'小心行事，谨慎前进。'},
      {name:'泰', desc:'小往大来，吉亨。', luck:'大吉', explain:'天地交泰，万事顺遂。'},
      {name:'否', desc:'否之匪人，不利君子贞，大往小来。', luck:'凶', explain:'闭塞不通，宜守静待变。'},
      {name:'同人', desc:'同人于野，亨。利涉大川，利君子贞。', luck:'吉', explain:'与人为善，合作共赢。'},
      {name:'大有', desc:'元亨。', luck:'大吉', explain:'收获丰盛，财运亨通。'},
      {name:'谦', desc:'亨，君子有终。', luck:'吉', explain:'谦虚谨慎，福泽自来。'},
      {name:'豫', desc:'利建侯，行师。', luck:'吉', explain:'心情愉快，顺势而为。'},
      {name:'随', desc:'元亨利贞，无咎。', luck:'吉', explain:'顺应变化，灵活应对。'},
      {name:'蛊', desc:'元亨，利涉大川。先甲三日，后甲三日。', luck:'中平', explain:'改革创新，去旧迎新。'},
      {name:'临', desc:'元亨利贞。至于八月有凶。', luck:'吉', explain:'居高临下，宜谦虚谨慎。'},
      {name:'观', desc:'盥而不荐，有孚顒若。', luck:'中平', explain:'观察形势，静观其变。'},
      {name:'噬嗑', desc:'亨。利用狱。', luck:'中平', explain:'解决障碍，宜果断处理。'},
      {name:'贲', desc:'亨。小利有攸往。', luck:'吉', explain:'外表美好，内在需充实。'},
      {name:'剥', desc:'不利有攸往。', luck:'凶', explain:'事物剥落，宜防损失。'},
      {name:'复', desc:'亨。出入无疾，朋来无咎。', luck:'吉', explain:'失而复得，重获新生。'},
      {name:'无妄', desc:'元亨利贞。其匪正有眚，不利有攸往。', luck:'凶', explain:'意外之事，宜守正道。'},
      {name:'大畜', desc:'利贞。不家食吉。利涉大川。', luck:'吉', explain:'积蓄力量，等待时机。'},
      {name:'颐', desc:'贞吉。观颐，自求口实。', luck:'吉', explain:'注重养生，饮食有节。'},
      {name:'大过', desc:'栋桡，利有攸往，亨。', luck:'中平', explain:'压力较大，宜量力而行。'},
      {name:'坎', desc:'习坎，有孚，维心亨，行有尚。', luck:'凶', explain:'多有阻碍，需谨慎前行。'},
      {name:'离', desc:'利贞，亨。畜牝牛吉。', luck:'吉', explain:'光明正大，前途光明。'},
      {name:'咸', desc:'亨，利贞。取女吉。', luck:'吉', explain:'感应良好，适合恋爱。'},
      {name:'恒', desc:'亨，无咎，利贞，利有攸往。', luck:'吉', explain:'持之以恒，终获成功。'},
      {name:'遁', desc:'亨，小利贞。', luck:'中平', explain:'退避三舍，暂避锋芒。'},
      {name:'大壮', desc:'利贞。', luck:'吉', explain:'力量增强，积极进取。'},
      {name:'晋', desc:'康侯用锡马蕃庶，昼日三接。', luck:'吉', explain:'步步高升，事业有成。'},
      {name:'明夷', desc:'利艰贞。', luck:'凶', explain:'光明受损，宜自我保护。'},
      {name:'家人', desc:'利女贞。', luck:'吉', explain:'家庭和睦，亲情为重。'},
      {name:'睽', desc:'小事吉。', luck:'中平', explain:'分歧矛盾，求同存异。'},
      {name:'蹇', desc:'利西南，不利东北。利见大人，贞吉。', luck:'中平', explain:'前路艰难，需寻求帮助。'},
      {name:'解', desc:'利西南，无咎。', luck:'吉', explain:'困境解除，问题迎刃而解。'},
      {name:'损', desc:'有孚，元吉，无咎，可贞，利有攸往。', luck:'吉', explain:'适当舍弃，反得大利。'},
      {name:'益', desc:'利有攸往，利涉大川。', luck:'吉', explain:'有所收获，利于前行。'},
      {name:'夬', desc:'扬于王庭，孚号有厉。', luck:'凶', explain:'果断决策，防范风险。'},
      {name:'姤', desc:'女壮，勿用取女。', luck:'凶', explain:'偶遇突发，宜谨慎应对。'},
      {name:'萃', desc:'亨，王假有庙，利见大人，利贞。', luck:'吉', explain:'众人聚集，合力成事。'},
      {name:'升', desc:'元亨，用见大人，勿恤，南征吉。', luck:'吉', explain:'步步高升，宜把握机会。'},
      {name:'困', desc:'亨，贞，大人吉，无咎，有言不信。', luck:'凶', explain:'处境困顿，需坚守信念。'},
      {name:'井', desc:'改邑不改井，无丧无得。往来井井。', luck:'中平', explain:'基础稳固，宜守成。'},
      {name:'革', desc:'己日乃孚。元亨利贞，悔亡。', luck:'吉', explain:'变革创新，去旧迎新。'},
      {name:'鼎', desc:'元吉，亨。', luck:'吉', explain:'鼎新革故，事业有成。'},
      {name:'震', desc:'亨，震来虩虩，笑言哑哑，震惊百里，不丧匕鬯。', luck:'吉', explain:'行动迅速，果断有为。'},
      {name:'艮', desc:'艮其背，不获其身，行其庭，不见其人，无咎。', luck:'中平', explain:'止步观望，宜静不宜动。'},
      {name:'渐', desc:'女归吉，利贞。', luck:'吉', explain:'循序渐进，水到渠成。'},
      {name:'归妹', desc:'征凶，无攸利。', luck:'凶', explain:'婚姻之事，需谨慎对待。'},
      {name:'丰', desc:'亨，王假之，勿忧，宜日中。', luck:'吉', explain:'收获丰富，宜珍惜当下。'},
      {name:'旅', desc:'小亨，旅贞吉。', luck:'吉', explain:'外出旅行，注意安全。'},
      {name:'巽', desc:'小亨，利有攸往，利见大人。', luck:'吉', explain:'谦逊有礼，利于进步。'},
      {name:'兑', desc:'亨，利贞。', luck:'吉', explain:'和悦待人，口才出众。'},
      {name:'涣', desc:'亨。王假有庙，利涉大川，利贞。', luck:'吉', explain:'分散聚合，顺势而为。'},
      {name:'节', desc:'亨，苦节不可贞。', luck:'中平', explain:'节制有度，过犹不及。'},
      {name:'中孚', desc:'豚鱼吉，利涉大川，利贞。', luck:'吉', explain:'诚信为本，吉祥如意。'},
      {name:'小过', desc:'亨，利贞，可小事，不可大事。飞鸟遗之音，不宜上，宜下，大吉。', luck:'吉', explain:'小事可成，大事难就。'},
      {name:'既济', desc:'亨小，利贞，初吉终乱。', luck:'中平', explain:'事情已成，慎防后变。'},
      {name:'未济', desc:'亨，苦节不可贞。', luck:'凶', explain:'尚未完成，需再努力。'},
    ];
    function randomYijingLines() {
      // 结合当前时间戳和随机生成六个爻（0=阴，1=阳），自下而上
      const now = Date.now();
      // 取毫秒的低6位作为部分爻
      const ms = now & 0b111111;
      let lines = [];
      for (let i = 0; i < 6; i++) {
        // 低三位用时间，后三位用随机
        if (i < 3) {
          lines.push((ms >> i) & 1);
        } else {
          lines.push(Math.random() > 0.5 ? 1 : 0);
        }
      }
      return lines;
    }
    function linesToHexIndex(lines) {
      // lines: [下, ..., 上]，转为二进制序号
      return parseInt(lines.slice().reverse().join(''),2);
    }
    function yijingToNumbers(lines, redMax, redCount, blueMax, blueCount) {
      // 用卦序号+爻分布映射号码
      let base = linesToHexIndex(lines);
      let reds = [];
      for (let i = 0; i < redCount; i++) {
        reds.push((base + i*3 + lines[i%6]*7) % redMax + 1);
      }
      let blues = [];
      for (let i = 0; i < blueCount; i++) {
        blues.push((base + i*7 + lines[(i+2)%6]*5) % blueMax + 1);
      }
      // 保证不重复
      reds = Array.from(new Set(reds));
      while (reds.length < redCount) {
        let n = Math.floor(Math.random()*redMax)+1;
        if (!reds.includes(n)) reds.push(n);
      }
      blues = Array.from(new Set(blues));
      while (blues.length < blueCount) {
        let n = Math.floor(Math.random()*blueMax)+1;
        if (!blues.includes(n)) blues.push(n);
      }
      return {red: reds, blue: blues};
    }
    function showYijingDialog() {
      const cfg = configs[mode];
      let customInfo = { name: '', birthday: '', lucky: '', blood: '' };
      let lastInfo = { name: '', birthday: '', lucky: '', blood: '' };

      function getCustomSeed() {
        let seed = Date.now();
        if (customInfo.name) {
          for (let c of customInfo.name) seed += c.charCodeAt(0);
        }
        if (customInfo.birthday) {
          seed += new Date(customInfo.birthday).getTime();
        }
        if (customInfo.lucky) {
          seed += parseInt(customInfo.lucky) || 0;
        }
        if (customInfo.blood) {
          // 血型A=1,B=2,AB=3,O=4
          const bloodMap = {A:1,B:2,AB:3,O:4};
          seed += bloodMap[customInfo.blood] || 0;
        }
        return seed;
      }

      function randomYijingLinesCustom() {
        // 用自定义seed影响六爻
        let seed = getCustomSeed();
        let lines = [];
        for (let i = 0; i < 6; i++) {
          seed = (seed * 9301 + 49297) % 233280;
          lines.push((seed >> (i % 8)) & 1);
        }
        return lines;
      }

      function isInfoChanged() {
        return customInfo.name !== lastInfo.name || customInfo.birthday !== lastInfo.birthday || customInfo.lucky !== lastInfo.lucky || customInfo.blood !== lastInfo.blood;
      }

      function getConstellation(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const m = d.getMonth() + 1, day = d.getDate();
        const arr = [
          ['摩羯座',1,20],['水瓶座',2,19],['双鱼座',3,21],['白羊座',4,20],['金牛座',5,21],['双子座',6,22],
          ['巨蟹座',7,23],['狮子座',8,23],['处女座',9,23],['天秤座',10,24],['天蝎座',11,23],['射手座',12,22],['摩羯座',12,32]
        ];
        for (let i = 0; i < arr.length; i++) {
          if ((m === arr[i][1] && day >= arr[i][2]) || (m === arr[i+1]?.[1] && day < arr[i+1]?.[2])) return arr[i][0];
        }
        return '';
      }
      function getFavColor(lucky, blood) {
        // 简单算法：幸运数字+血型映射
        if (!lucky && !blood) return '';
        const colors = ['#ff4d4f','#faad14','#52c41a','#1890ff','#722ed1','#13c2c2','#eb2f96','#a0a0a0'];
        const bloodMap = {A:1,B:2,AB:3,O:4};
        let idx = (parseInt(lucky)||0) + (bloodMap[blood]||0);
        return colors[idx % colors.length];
      }
      function getFavColorName(hex) {
        // 简单映射
        const map = {
          '#ff4d4f':'红色','#faad14':'橙色','#52c41a':'绿色','#1890ff':'蓝色','#722ed1':'紫色','#13c2c2':'青色','#eb2f96':'粉色','#a0a0a0':'灰色'
        };
        return map[hex]||'彩色';
      }
      function getWorry(blood, constellation, lucky) {
        // 简单映射
        if (!blood && !constellation && !lucky) return '暂无';
        if (blood==='A') return '追求完美，易纠结';
        if (blood==='B') return '想法多变，怕受束缚';
        if (blood==='AB') return '理性与感性并存，易犹豫';
        if (blood==='O') return '在意结果，怕失去控制';
        if (constellation==='巨蟹座') return '情感细腻，怕被忽视';
        if (constellation==='处女座') return '追求细节，怕不完美';
        if ((parseInt(lucky)||0)%2===0) return '担心运气不够用';
        return '希望一切顺利';
      }

      function genResult() {
        const now = new Date();
        const lines = randomYijingLinesCustom();
        const idx = linesToHexIndex(lines) % 64;
        const hex = yijingHexagrams[idx];
        const nums = yijingToNumbers(lines, cfg.red.max, cfg.red.count, cfg.blue.max, cfg.blue.count);
        // 卦象图（横向紧凑）
        let linesHtml = lines.slice().reverse().map(v =>
          v
            ? '<span style="font-size:22px;margin:0 2px;color:#1890ff;">⚊</span>'
            : '<span style="font-size:22px;margin:0 2px;color:#888;">⚋</span>'
        ).join('');
        // 号码
        let redHtml = nums.red.slice().sort((a,b)=>a-b).map(n=>`<span style='color:#ff4d4f;font-weight:bold;font-size:18px;'>${n<10?'0'+n:n}</span>`).join(' ');
        let blueHtml = nums.blue.slice().sort((a,b)=>a-b).map(n=>`<span style='color:#1890ff;font-weight:bold;font-size:18px;'>${n<10?'0'+n:n}</span>`).join(' ');
        // 时间字符串
        let timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ` +
                      `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}.${now.getMilliseconds().toString().padStart(3,'0')}`;
        // 个人信息表单
        let formHtml = `<div style='margin-bottom:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;'>`
          + `<label>姓名：<input id='yijing-name' type='text' value='${customInfo.name||''}' style='width:80px;margin-right:8px;'></label>`
          + `<label>生日：<input id='yijing-birthday' type='date' value='${customInfo.birthday||''}' style='margin-right:8px;'></label>`
          + `<label>幸运数字：<input id='yijing-lucky' type='number' value='${customInfo.lucky||''}' style='width:60px;'></label>`
          + `<label>血型：<select id='yijing-blood' style='width:60px;'><option value=''>--</option><option value='A'${customInfo.blood==='A'?' selected':''}>A</option><option value='B'${customInfo.blood==='B'?' selected':''}>B</option><option value='AB'${customInfo.blood==='AB'?' selected':''}>AB</option><option value='O'${customInfo.blood==='O'?' selected':''}>O</option></select></label>`
          + `<button id='yijing-setinfo' style='margin-left:8px;background:${isInfoChanged() ? '#1890ff' : '#ccc'};color:#fff;border:none;border-radius:6px;padding:4px 14px;font-size:15px;cursor:${isInfoChanged() ? 'pointer' : 'not-allowed'};' ${isInfoChanged() ? '' : 'disabled'}>确定</button>`
          + `</div>`;
        // 头部信息
        let headInfo = '';
        let constellation = getConstellation(customInfo.birthday);
        let favColorHex = getFavColor(customInfo.lucky, customInfo.blood);
        let favColorName = getFavColorName(favColorHex);
        let worry = getWorry(customInfo.blood, constellation, customInfo.lucky);
        if (customInfo.name || constellation || favColorName || worry) {
          headInfo = `<div style='font-size:15px;color:#888;margin-bottom:4px;'>` +
            (customInfo.name ? `<span style='color:#2d8cf0;font-weight:bold;'>${customInfo.name}</span> ` : '') +
            (constellation ? `| 星座：<span style='color:#faad14;'>${constellation}</span> ` : '') +
            (favColorName ? `| 喜欢的颜色：<span style='color:${favColorHex};font-weight:bold;'>${favColorName}</span> ` : '') +
            (worry ? `| 当前的顾虑：<span style='color:#eb2f96;'>${worry}</span>` : '') +
            `</div>`;
        }
        // 内容
        let html = formHtml;
        html += `<div style='font-size:18px;font-weight:bold;margin-bottom:8px;'>周易出号${customInfo.name ? ' - ' + customInfo.name : ''}</div>`;
        html += headInfo;
        html += `<div style='font-size:15px;color:#888;margin-bottom:6px;'>本次点击时间：<span style='color:#2d8cf0;font-weight:bold;'>${timeStr}</span></div>`;
        html += `<div style='display:flex;gap:18px;align-items:center;margin-bottom:10px;'><div>${linesHtml}</div><div><div style='font-size:17px;font-weight:bold;'>${hex.name}卦<span style='font-size:14px;color:#888;font-weight:normal;'>（${hex.explain}）</span></div><div style='font-size:15px;color:#888;'>${hex.desc}</div><div style='font-size:15px;color:#faad14;font-weight:bold;'>吉凶：${hex.luck}</div></div></div>`;
        html += `<div style='margin-bottom:10px;'><b>本卦选号：</b><span>${redHtml} + ${blueHtml}</span></div>`;
        html += `<div style='font-size:14px;color:#888;margin-bottom:8px;'>仅供娱乐，祝君好运！（如需结合使用者命格之高阶应用请联系版权所有人）</div>`;
        html += `<div style='text-align:right;'><button id='yijing-again' style='background:#722ed1;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:15px;cursor:pointer;'>再摇一次</button></div>`;
        return html;
      }
      function show() {
        showTestResult('', null, genResult());
        setTimeout(()=>{
          // 个人信息表单事件
          const nameInput = document.getElementById('yijing-name');
          const birthdayInput = document.getElementById('yijing-birthday');
          const luckyInput = document.getElementById('yijing-lucky');
          const setBtn = document.getElementById('yijing-setinfo');
          const bloodInput = document.getElementById('yijing-blood');
          if (setBtn) setBtn.onclick = () => {
            customInfo.name = nameInput.value.trim();
            customInfo.birthday = birthdayInput.value;
            customInfo.lucky = luckyInput.value.trim();
            customInfo.blood = bloodInput.value;
            lastInfo = { ...customInfo };
            show();
          };
          // 输入变化时动态刷新按钮状态
          [nameInput, birthdayInput, luckyInput, bloodInput].forEach(input => {
            if (input) input.oninput = input.onchange = () => {
              customInfo.name = nameInput.value.trim();
              customInfo.birthday = birthdayInput.value;
              customInfo.lucky = luckyInput.value.trim();
              customInfo.blood = bloodInput.value;
              // 只刷新表单部分
              const btn = document.getElementById('yijing-setinfo');
              if (btn) {
                const changed = isInfoChanged();
                btn.style.background = changed ? '#1890ff' : '#ccc';
                btn.style.cursor = changed ? 'pointer' : 'not-allowed';
                btn.disabled = !changed;
              }
            };
          });
          const againBtn = document.getElementById('yijing-again');
          if (againBtn) againBtn.onclick = show;
        }, 100);
      }
      show();
    }

    renderGame();
  </script>
</body>
</html> 