<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å½©ç¥¨å¤§ç©å®¶</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin: 0; padding: 0; font-size: 17px; }
    .container { 
      max-width: 520px; 
      margin: 40px auto; 
      background: rgba(255,255,255,0.9); 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      padding: 36px 20px; 
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    h1 { text-align: center; color: #2d8cf0; letter-spacing: 2px; margin-bottom: 18px; font-size: 2.2em; display: flex; align-items: center; justify-content: center; }
    .game-mode { display: flex; justify-content: center; margin-bottom: 24px; gap: 10px; }
    .game-mode button { margin: 0 8px; padding: 8px 24px; border: none; border-radius: 8px; background: #e6e6e6; color: #333; font-size: 16px; cursor: pointer; transition: background 0.2s; }
    .game-mode button.active { background: #2d8cf0; color: #fff; }
    .section { margin-bottom: 22px; }
    .balls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .ball { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; cursor: pointer; border: 2px solid #eee; background: #f7f7f7; transition: all 0.3s ease; }
    .ball.selected { background: #2d8cf0; color: #fff; border: 2px solid #2d8cf0; }
    .ball.red { background: #ffeaea; color: #ff4d4f; border: 2px solid #ffb3b3; }
    .ball.blue { background: #e6f0ff; color: #1890ff; border: 2px solid #91caff; }
    .ball.gray { background: #eee; color: #aaa; border: 2px solid #aaa; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #2d8cf0;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
      margin: 5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .actions button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .actions button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .actions input[type=number] { height: 30px; font-size: 15px; border-radius: 5px; border: 1px solid #d9d9d9; padding: 0 6px; margin: 0 2px; }
    .actions select { height: 32px; font-size: 15px; border-radius: 5px; border: 1px solid #d9d9d9; margin-right: 2px; }
    .result { background: #f0f9ff; border-left: 4px solid #2d8cf0; padding: 12px 16px; border-radius: 6px; margin-top: 16px; }
    .lottery-balls { display: flex; gap: 8px; margin-top: 8px; }
    .lottery-balls .ball { cursor: default; }
    .open-area {
      background: linear-gradient(135deg, rgba(255,229,143,0.8) 0%, rgba(255,215,0,0.2) 100%);
      box-shadow: 0 4px 20px rgba(255,215,0,0.2);
      border-radius: 10px;
      border: 1.5px solid gold;
      margin-bottom: 28px;
      padding: 14px 10px 10px 10px;
      text-align: center;
      animation: openfade 1s;
      font-size: 18px;
    }
    .gold-animate { border: 2px solid gold !important; box-shadow: 0 0 10px #ffd70088; animation: goldflash 1.2s linear infinite alternate; }
    @keyframes goldflash {
      0% { box-shadow: 0 0 10px #ffd70088, 0 0 0 #fff0; }
      100% { box-shadow: 0 0 24px #ffd700cc, 0 0 8px #fffbe6; }
    }
    @keyframes openfade {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }
    .section .number-line { margin: 10px 0 14px 0; padding: 8px 10px; border-radius: 10px; font-size: 17px; line-height: 2.1; transition: box-shadow 0.2s; }
    .section .number-line:not(:last-child) { margin-bottom: 14px; }
    .section .number-line.winning {
      background: linear-gradient(135deg, rgba(246,255,237,0.9) 0%, rgba(183,235,143,0.8) 100%);
      box-shadow: 0 4px 12px rgba(82,196,26,0.2);
      border: 2px solid #52c41a;
      box-shadow: 0 0 8px #b7eb8f;
      background: #f6ffed;
      color: #222;
    }
    .section .number-line.losing { color: #aaa; background: #fafafa; border: 1px solid #eee; }
    @media (max-width: 600px) {
      .container { padding: 20px 10px; max-width: 100%; margin: 20px auto; }
      .game-mode { flex-wrap: wrap; justify-content: center; }
      .game-mode button { margin: 4px; padding: 6px 12px; font-size: 14px; }
      .actions { justify-content: center; gap: 6px; }
      .actions button {
        padding: 8px 16px;
        font-size: 15px;
        min-width: 80px;
      }
      .actions select { height: 30px; font-size: 14px; }
      .actions input[type=number] { height: 28px; font-size: 14px; }
      .balls { gap: 4px; }
      .ball { width: 30px; height: 30px; font-size: 14px; }
      .open-area { font-size: 15px; }
      .section .number-line { font-size: 15px; padding: 6px 4px; }
      h1 { font-size: 1.3em !important; letter-spacing: 1px; margin-bottom: 12px; }
      .container h1 span { font-size: 1em !important; margin-right: 6px !important; }
      /* å‘¨æ˜“å‡ºå·è¡¨å•é€‚é… */
      #yijing-form-row { flex-wrap: wrap; gap: 4px !important; font-size: 13px !important; }
      #yijing-form-row label { margin-right: 2px !important; }
      #yijing-form-row input, #yijing-form-row select { font-size: 13px !important; height: 26px !important; padding: 2px 4px !important; width: 60px !important; min-width: 0 !important; }
      #yijing-form-row input[type="text"] { width: 60px !important; }
      #yijing-form-row input[type="date"] { width: 110px !important; }
      #yijing-setinfo { padding: 3px 8px !important; font-size: 13px !important; margin-left: 4px !important; }
    }
    .ball:hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="font-size:2.2em;letter-spacing:3px;display:flex;align-items:center;justify-content:center;">
      <span style="font-size:1.2em;margin-right:10px;">ğŸ¯</span>å½©ç¥¨å¤§ç©å®¶
    </h1>
    <div class="game-mode">
      <button id="mode-ssq" class="active">åŒè‰²çƒ</button>
      <button id="mode-dlt">å¤§ä¹é€</button>
    </div>
    <div id="game-area"></div>
  </div>
  <div style="text-align:center;color:#888;font-size:13px;margin:30px 0 10px 0;">
    ç‰ˆæƒæ‰€æœ‰äººï¼š<a href="weixin://contacts/profile/xthend" style="color:#2d8cf0;text-decoration:underline;" target="_blank">å¤šå®çˆ¸</a>
  </div>
  <script>
  (function() {
    // æ¸¸æˆé…ç½®
    const configs = {
      ssq: {
        name: 'åŒè‰²çƒ',
        red: { count: 6, max: 33 },
        blue: { count: 1, max: 16 },
        prize: [
          { matchRed: 6, matchBlue: 1, name: 'ä¸€ç­‰å¥–', bonus: '1000ä¸‡' },
          { matchRed: 6, matchBlue: 0, name: 'äºŒç­‰å¥–', bonus: '150ä¸‡' },
          { matchRed: 5, matchBlue: 1, name: 'ä¸‰ç­‰å¥–', bonus: '3000å…ƒ' },
          { matchRed: 5, matchBlue: 0, name: 'å››ç­‰å¥–', bonus: '200å…ƒ' },
          { matchRed: 4, matchBlue: 1, name: 'å››ç­‰å¥–', bonus: '200å…ƒ' },
          { matchRed: 4, matchBlue: 0, name: 'äº”ç­‰å¥–', bonus: '10å…ƒ' },
          { matchRed: 3, matchBlue: 1, name: 'äº”ç­‰å¥–', bonus: '10å…ƒ' },
          { matchRed: 2, matchBlue: 1, name: 'å…­ç­‰å¥–', bonus: '5å…ƒ' },
          { matchRed: 1, matchBlue: 1, name: 'å…­ç­‰å¥–', bonus: '5å…ƒ' },
          { matchRed: 0, matchBlue: 1, name: 'å…­ç­‰å¥–', bonus: '5å…ƒ' },
        ]
      },
      dlt: {
        name: 'å¤§ä¹é€',
        red: { count: 5, max: 35 },
        blue: { count: 2, max: 12 },
        prize: [
          { matchRed: 5, matchBlue: 2, name: 'ä¸€ç­‰å¥–', bonus: '1000ä¸‡' },
          { matchRed: 5, matchBlue: 1, name: 'äºŒç­‰å¥–', bonus: '100ä¸‡' },
          { matchRed: 5, matchBlue: 0, name: 'ä¸‰ç­‰å¥–', bonus: '10000å…ƒ' },
          { matchRed: 4, matchBlue: 2, name: 'å››ç­‰å¥–', bonus: '3000å…ƒ' },
          { matchRed: 4, matchBlue: 1, name: 'äº”ç­‰å¥–', bonus: '300å…ƒ' },
          { matchRed: 3, matchBlue: 2, name: 'å…­ç­‰å¥–', bonus: '200å…ƒ' },
          { matchRed: 4, matchBlue: 0, name: 'ä¸ƒç­‰å¥–', bonus: '100å…ƒ' },
          { matchRed: 3, matchBlue: 1, name: 'å…«ç­‰å¥–', bonus: '15å…ƒ' },
          { matchRed: 2, matchBlue: 2, name: 'å…«ç­‰å¥–', bonus: '15å…ƒ' },
          { matchRed: 3, matchBlue: 0, name: 'ä¹ç­‰å¥–', bonus: '5å…ƒ' },
          { matchRed: 1, matchBlue: 2, name: 'ä¹ç­‰å¥–', bonus: '5å…ƒ' },
          { matchRed: 2, matchBlue: 1, name: 'ä¹ç­‰å¥–', bonus: '5å…ƒ' },
          { matchRed: 0, matchBlue: 2, name: 'ä¹ç­‰å¥–', bonus: '5å…ƒ' },
        ]
      }
    };

    let mode = 'ssq';
    let userRed = [], userBlue = [];
    let lotteryRed = [], lotteryBlue = [];
    let result = null;
    let betCount = 1; // æ³¨æ•°ï¼Œé»˜è®¤1
    let userNumbers = []; // å¤šæ³¨é€‰å·
    let lotteryNumbers = []; // å¤šæ³¨å¼€å¥–å·ç 
    let results = []; // å¤šæ³¨ç»“æœ
    let jackpotNumbers = null;
    let hasDrawed = false; // æ˜¯å¦å·²ç»å¼€å¥–è¿‡
    let luckyTaskId = 0;

    function renderGame() {
      const cfg = configs[mode];
      const area = document.getElementById('game-area');
      area.innerHTML = '';
      // é€‰å·åŒº
      const section1 = document.createElement('div');
      section1.className = 'section';
      section1.innerHTML = `<b>è¯·é€‰æ‹©${cfg.red.count}ä¸ªçº¢çƒ</b>ï¼ˆ1-${cfg.red.max}ï¼‰`;
      const ballsRed = document.createElement('div');
      ballsRed.className = 'balls';
      for (let i = 1; i <= cfg.red.max; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball' + (userRed.includes(i) ? ' selected red' : '');
        ball.textContent = i < 10 ? '0' + i : i;
        ball.onclick = () => {
          if (userRed.includes(i)) {
            userRed = userRed.filter(x => x !== i);
          } else {
            if (userRed.length < cfg.red.count) userRed.push(i);
          }
          renderGame();
        };
        ballsRed.appendChild(ball);
      }
      section1.appendChild(ballsRed);
      area.appendChild(section1);
      // è“çƒ/ååŒº
      const section2 = document.createElement('div');
      section2.className = 'section';
      section2.innerHTML = `<b>è¯·é€‰æ‹©${cfg.blue.count}ä¸ª${mode==='ssq'?'è“çƒ':'ååŒº'}</b>ï¼ˆ1-${cfg.blue.max}ï¼‰`;
      const ballsBlue = document.createElement('div');
      ballsBlue.className = 'balls';
      for (let i = 1; i <= cfg.blue.max; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball' + (userBlue.includes(i) ? ' selected blue' : '');
        ball.textContent = i < 10 ? '0' + i : i;
        ball.onclick = () => {
          if (userBlue.includes(i)) {
            userBlue = userBlue.filter(x => x !== i);
          } else {
            if (userBlue.length < cfg.blue.count) userBlue.push(i);
          }
          renderGame();
        };
        ballsBlue.appendChild(ball);
      }
      section2.appendChild(ballsBlue);
      area.appendChild(section2);
      // æ“ä½œåŒº
      const actions = document.createElement('div');
      actions.className = 'actions';
      // æ³¨æ•°é€‰æ‹©å™¨
      const betSelect = document.createElement('select');
      [1,5,20,100,500,1000].forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = `${n}æ³¨`;
        if (betCount === n) opt.selected = true;
        betSelect.appendChild(opt);
      });
      betSelect.onchange = e => {
        betCount = parseInt(e.target.value);
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(betSelect);
      // éšæœºé€‰å·
      const btnRand = document.createElement('button');
      btnRand.textContent = 'éšæœºé€‰å·';
      btnRand.onclick = () => {
        // åªæ›¿æ¢æœºé€‰å·ç ï¼Œä¿ç•™æ‰‹åŠ¨åŠ çš„å·ç 
        let manualNums = userNumbers.filter(num => num.manual);
        let autoCount = betCount - manualNums.length;
        let autoNums = [];
        for (let i = 0; i < autoCount; i++) {
          autoNums.push({
            red: randomBalls(cfg.red.max, cfg.red.count),
            blue: randomBalls(cfg.blue.max, cfg.blue.count)
          });
        }
        userNumbers = manualNums.concat(autoNums);
        if (userNumbers.length > 0) {
          userRed = userNumbers[0].red.slice();
          userBlue = userNumbers[0].blue.slice();
        }
        result = null;
        results = [];
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(btnRand);
      // æ¸…ç©ºé€‰å·
      const btnClear = document.createElement('button');
      btnClear.textContent = 'æ¸…ç©ºé€‰å·';
      btnClear.onclick = () => {
        userRed = [];
        userBlue = [];
        userNumbers = [];
        result = null;
        results = [];
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(btnClear);
      // æ‰‹åŠ¨åŠ ä¸€æ³¨
      const btnManualAdd = document.createElement('button');
      btnManualAdd.textContent = 'æ‰‹åŠ¨åŠ ä¸€æ³¨';
      btnManualAdd.disabled = !(userRed.length === cfg.red.count && userBlue.length === cfg.blue.count && userNumbers.length < betCount);
      btnManualAdd.onclick = () => {
        userNumbers.push({red: userRed.slice(), blue: userBlue.slice(), manual: true});
        userRed = [];
        userBlue = [];
        hasDrawed = false;
        renderGame();
      };
      actions.appendChild(btnManualAdd);
      // å¼€å¥–
      const btnDraw = document.createElement('button');
      btnDraw.textContent = 'å¼€å¥–';
      let valid = userNumbers.length > 0 && userNumbers.every(num => num.red.length === cfg.red.count && num.blue.length === cfg.blue.count);
      btnDraw.disabled = !valid;
      btnDraw.onclick = () => {
        if (!hasDrawed) {
          // ç¬¬ä¸€æ¬¡å¼€å¥–ï¼ŒuserNumbersä¸ºç©ºæ—¶ç”¨é€‰å·åŒºå·ç 
          if (userNumbers.length === 0) {
            userNumbers = [{red: userRed.slice(), blue: userBlue.slice()}];
          }
        } else {
          // åç»­å¼€å¥–åªéšæœºéæ‰‹åŠ¨å·ç 
          let manualNums = userNumbers.filter(num => num.manual);
          let autoCount = betCount - manualNums.length;
          let autoNums = [];
          for (let i = 0; i < autoCount; i++) {
            autoNums.push({
              red: randomBalls(cfg.red.max, cfg.red.count),
              blue: randomBalls(cfg.blue.max, cfg.blue.count)
            });
          }
          userNumbers = manualNums.concat(autoNums);
        }
        // åªç”Ÿæˆä¸€ç»„å¼€å¥–å·ç 
        const lRed = randomBalls(cfg.red.max, cfg.red.count);
        const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
        lotteryNumbers = [{red: lRed, blue: lBlue}];
        results = [];
        for (let i = 0; i < userNumbers.length; i++) {
          results.push(checkPrize(userNumbers[i].red, userNumbers[i].blue, lRed, lBlue));
        }
        renderGame();
        hasDrawed = true;
      };
      actions.appendChild(btnDraw);
      // å®ˆå·å†å¼€å¥–
      const btnKeep = document.createElement('button');
      btnKeep.textContent = 'å®ˆå·å†å¼€å¥–';
      btnKeep.disabled = !valid;
      btnKeep.onclick = () => {
        // åªç”Ÿæˆä¸€ç»„æ–°å¼€å¥–å·ç ï¼Œç”¨æˆ·å·ç ä¸å˜
        const lRed = randomBalls(cfg.red.max, cfg.red.count);
        const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
        lotteryNumbers = [{red: lRed, blue: lBlue}];
        results = [];
        for (let i = 0; i < betCount; i++) {
          results.push(checkPrize(userNumbers[i].red, userNumbers[i].blue, lRed, lBlue));
        }
        renderGame();
      };
      actions.appendChild(btnKeep);

      // æµ‹è¯•å¼€å¥–
      const testInput = document.createElement('input');
      testInput.type = 'number';
      testInput.min = 1;
      testInput.max = 100000;
      testInput.value = 100000;
      testInput.style.width = '70px';
      testInput.style.marginLeft = '8px';
      testInput.title = 'æœ€å¤§å¼€å¥–æ¬¡æ•°';
      actions.appendChild(testInput);

      const btnTest = document.createElement('button');
      btnTest.textContent = 'æµ‹è¯•å¼€å¥–';
      btnTest.disabled = !valid;
      btnTest.onclick = () => {
        const maxTimes = Math.max(1, Math.min(100000, parseInt(testInput.value)));
        let totalCost = 0;
        let totalWin = 0;
        let times = 0;
        let jackpotHit = false;
        let jackpotIdx = -1;
        let jackpotName = '';
        const cfg = configs[mode];
        // å¥–é¡¹ç»Ÿè®¡ï¼ˆåˆå¹¶åŒåå¥–é¡¹ï¼‰
        const prizeCount = {};
        cfg.prize.forEach(p => { prizeCount[p.name] = 0; });
        // å¼¹çª—+è¿›åº¦æ¡
        let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>æµ‹è¯•å¼€å¥–</div>`;
        html += `<div style='font-size:15px;color:#888;margin-bottom:10px;'>æœ¬åŠŸèƒ½å°†æ¨¡æ‹Ÿå¤§é‡å¼€å¥–ï¼Œç»Ÿè®¡ä¸­å¥–é‡‘é¢å’Œå¥–é¡¹åˆ†å¸ƒã€‚</div>`;
        html += `<div id='test-progress-text' style='margin-bottom:4px;font-size:15px;color:#888;'>å·²å®Œæˆ 0%ï¼ˆ0/${maxTimes}ï¼‰</div>`;
        html += `<div id='test-progress' style='width:100%;height:18px;background:#eee;border-radius:8px;overflow:hidden;margin-bottom:16px;position:relative;'><div id='test-bar' style='height:100%;width:0%;background:linear-gradient(90deg,#2d8cf0,#52c41a,#faad14);transition:width 0.2s;position:absolute;left:0;top:0;'></div><div id='test-bar-text' style='position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333;font-weight:bold;pointer-events:none;'>0%</div></div>`;
        showTestResult('', null, html);
        // åˆ†æ‰¹å¼‚æ­¥å¼€å¥–
        const batch = 1000;
        function processBatch() {
          let processed = 0;
          while (times < maxTimes && !jackpotHit && processed < batch) {
            const lRed = randomBalls(cfg.red.max, cfg.red.count);
            const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
            totalCost += betCount * 2;
            for (let i = 0; i < betCount; i++) {
              const user = userNumbers[i];
              const r = checkPrize(user.red, user.blue, lRed, lBlue);
              if (r && r.bonus) {
                let bonus = 0;
                if (r.bonus.includes('ä¸‡')) {
                  bonus = parseFloat(r.bonus) * 10000;
                } else if (r.bonus.includes('å…ƒ')) {
                  bonus = parseFloat(r.bonus);
                }
                totalWin += bonus;
                if (prizeCount[r.name] !== undefined) prizeCount[r.name]++;
                if (r.name === cfg.prize[0].name) {
                  jackpotHit = true;
                  jackpotIdx = times + 1;
                  jackpotName = r.name;
                  jackpotNumbers = {red: lRed.slice(), blue: lBlue.slice()};
                  break;
                }
              }
            }
            times++;
            processed++;
          }
          // æ›´æ–°è¿›åº¦æ¡
          const percent = Math.floor(times / maxTimes * 100);
          const bar = document.getElementById('test-bar');
          const barText = document.getElementById('test-bar-text');
          const progText = document.getElementById('test-progress-text');
          if (bar) bar.style.width = percent + '%';
          if (barText) barText.textContent = percent + '%';
          if (progText) progText.textContent = `å·²å®Œæˆ ${percent}%ï¼ˆ${times}/${maxTimes}ï¼‰`;
          if (times < maxTimes && !jackpotHit) {
            setTimeout(processBatch, 0);
          } else {
            // ç»“æ„åŒ–é«˜äº®å†…å®¹
            const profit = totalWin - totalCost;
            let highlight = `<div style='margin-bottom:8px;'><b>å¼€å¥–æ¬¡æ•°ï¼š</b><span style='color:#2d8cf0;font-weight:bold;'>${times}</span>ï¼Œ<b>æ³¨æ•°ï¼š</b>${betCount}</div>`;
            highlight += `<div style='margin-bottom:8px;'><b>æ€»èŠ±è´¹ï¼š</b><span style='color:#fa541c;font-weight:bold;'>${totalCost}å…ƒ</span></div>`;
            highlight += `<div style='margin-bottom:8px;'><b>ä¸­å¥–é‡‘é¢ï¼š</b><span style='color:#52c41a;font-weight:bold;'>${totalWin}å…ƒ</span></div>`;
            highlight += `<div style='margin-bottom:8px;'><b>ç›ˆäºï¼š</b><span style='color:${profit>=0?'#52c41a':'#fa541c'};font-weight:bold;'>${profit>=0?'+'+profit:profit}å…ƒ</span></div>`;
            // å¥–é¡¹ç»Ÿè®¡
            const shown = new Set();
            let prizeMsg = '';
            for (const p of cfg.prize) {
              if (!shown.has(p.name) && prizeCount[p.name]) {
                prizeMsg += `<div><b>${p.name}ï¼š</b><span style='color:#2d8cf0;font-weight:bold;'>${prizeCount[p.name]}</span> æ¬¡</div>`;
                shown.add(p.name);
              }
            }
            if (prizeMsg) highlight += `<div style='margin:10px 0 8px 0;'><b>å„å¥–é¡¹ä¸­å¥–æ¬¡æ•°ï¼š</b>${prizeMsg}</div>`;
            if (jackpotHit) {
              highlight += `<div style='margin:10px 0 8px 0;'><b>å¤´å¥–å‡ºç°ï¼š</b>ç¬¬<span style='color:#faad14;font-weight:bold;'>${jackpotIdx}</span>æ¬¡å¼€å¥–ï¼Œ<b>å¥–é¡¹ï¼š</b><span style='color:#faad14;font-weight:bold;'>${jackpotName}</span></div>`;
            } else {
              highlight += `<div style='margin:10px 0 8px 0;'><b>å¤´å¥–ï¼š</b><span style='color:#aaa;'>æœªä¸­å¤´å¥–</span></div>`;
            }
            showTestResult('', jackpotHit ? jackpotNumbers : null, highlight);
          }
        }
        processBatch();
      };
      actions.appendChild(btnTest);

      // å¹¸è¿å·ç ç»„
      const btnLucky = document.createElement('button');
      btnLucky.textContent = 'å¹¸è¿å·ç ç»„';
      btnLucky.style.background = 'linear-gradient(90deg,#faad14,#52c41a,#1890ff)';
      btnLucky.style.color = '#fff';
      btnLucky.style.fontWeight = 'bold';
      btnLucky.onclick = () => {
        const thisTaskId = Date.now() + Math.random();
        luckyTaskId = thisTaskId;
        const cfg = configs[mode];
        // 1. éšæœº1000æ³¨
        let luckyNumbers = [];
        for (let i = 0; i < 1000; i++) {
          luckyNumbers.push({
            red: randomBalls(cfg.red.max, cfg.red.count),
            blue: randomBalls(cfg.blue.max, cfg.blue.count)
          });
        }
        // å¼¹çª—+è¿›åº¦æ¡
        let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>å¹¸è¿å·ç ç»„</div>`;
        html += `<div style='font-size:15px;color:#888;margin-bottom:10px;'>æœ¬åŠŸèƒ½å°†éšæœºç”Ÿæˆ1000ç»„å·ç ï¼Œåˆ†åˆ«è¿›è¡Œ5æ¬¡å…±50ä¸‡æ¬¡å¼€å¥–ï¼Œç»Ÿè®¡ä¸­å¥–é‡‘é¢æœ€é«˜çš„å‰5ç»„å·ç ã€‚</div>`;
        html += `<div id='lucky-progress-text' style='margin-bottom:4px;font-size:15px;color:#888;'>æ­£åœ¨è®¡ç®—å¹¸è¿å·ç ç»„ï¼šå·²å®Œæˆ 0%ï¼ˆ0/500000ï¼‰</div>`;
        html += `<div id='lucky-progress' style='width:100%;height:18px;background:#eee;border-radius:8px;overflow:hidden;margin-bottom:16px;position:relative;'><div id='lucky-bar' style='height:100%;width:0%;background:linear-gradient(90deg,#faad14,#52c41a,#1890ff);transition:width 0.2s;position:absolute;left:0;top:0;'></div><div id='lucky-bar-text' style='position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333;font-weight:bold;pointer-events:none;'>0%</div></div>`;
        showTestResult('', null, html, () => { luckyTaskId = 0; });
        // 2. åˆ†æ‰¹å¼‚æ­¥è®¡ç®—
        let winAmounts = Array(1000).fill(0);
        let group = 0, t = 0;
        const totalGroups = 5, totalTimes = 100000;
        const totalSteps = totalGroups * totalTimes;
        let step = 0;
        function processBatch() {
          if (luckyTaskId !== thisTaskId) return;
          let batch = 500; // æ¯æ‰¹å¤„ç†500æ¬¡å¼€å¥–
          let processed = 0;
          while (group < totalGroups && processed < batch) {
            const lRed = randomBalls(cfg.red.max, cfg.red.count);
            const lBlue = randomBalls(cfg.blue.max, cfg.blue.count);
            for (let i = 0; i < 1000; i++) {
              const r = checkPrize(luckyNumbers[i].red, luckyNumbers[i].blue, lRed, lBlue);
              if (r && r.bonus) {
                let bonus = 0;
                if (r.bonus.includes('ä¸‡')) {
                  bonus = parseFloat(r.bonus) * 10000;
                } else if (r.bonus.includes('å…ƒ')) {
                  bonus = parseFloat(r.bonus);
                }
                winAmounts[i] += bonus;
              }
            }
            t++;
            step++;
            processed++;
            if (t >= totalTimes) { t = 0; group++; }
          }
          // æ›´æ–°è¿›åº¦æ¡
          const percent = Math.floor(step / totalSteps * 100);
          const bar = document.getElementById('lucky-bar');
          const barText = document.getElementById('lucky-bar-text');
          const progText = document.getElementById('lucky-progress-text');
          if (bar) bar.style.width = percent + '%';
          if (barText) barText.textContent = percent + '%';
          if (progText) progText.textContent = `æ­£åœ¨è®¡ç®—å¹¸è¿å·ç ç»„ï¼šå·²å®Œæˆ ${percent}%ï¼ˆ${step}/${totalSteps}ï¼‰`;
          if (group < totalGroups) {
            setTimeout(processBatch, 0);
          } else if (luckyTaskId === thisTaskId) {
            // 3. æ‰¾å‡ºä¸­å¥–é‡‘é¢æœ€é«˜çš„å‰5ä¸ªå·ç 
            let topIdx = winAmounts.map((amount, idx) => ({amount, idx}))
              .sort((a,b)=>b.amount-a.amount)
              .slice(0,5)
              .map(x=>x.idx);
            // 4. å±•ç¤º
            let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>å¹¸è¿å·ç ç»„ï¼ˆéšæœº1000æ³¨ï¼Œ5Ã—10ä¸‡æ¬¡å¼€å¥–ï¼Œå¥–é‡‘å‰5åï¼‰ï¼š</div>`;
            topIdx.forEach((idx,rank) => {
              const num = luckyNumbers[idx];
              const amount = winAmounts[idx];
              const redText = num.red.slice().sort((a,b)=>a-b).map(n => `<span style='color:#ffd700;font-weight:bold;font-size:15px;background:#fffbe6;padding:1px 4px;border-radius:5px;margin-right:1px;'>${n<10?'0'+n:n}</span>`).join(' ');
              const blueText = num.blue.slice().sort((a,b)=>a-b).map(n => `<span style='color:#1890ff;font-weight:bold;font-size:15px;background:#e6f7ff;padding:1px 4px;border-radius:5px;margin-right:1px;'>${n<10?'0'+n:n}</span>`).join(' ');
              html += `<div style='margin:4px 0 0 0;padding:5px 8px;border-radius:7px;background:linear-gradient(90deg,#faad14,#52c41a,#1890ff);color:#fff;box-shadow:0 1px 4px #0001;display:flex;align-items:center;min-height:28px;'>`;
              html += `<span style='font-size:15px;font-weight:bold;margin-right:10px;color:#ffd700;'>NO.${rank+1}</span> <span style='font-size:15px;'>${redText} + ${blueText}</span> <span style='margin-left:auto;font-size:14px;'>ä¸­å¥–é‡‘é¢ï¼š${amount}å…ƒ</span>`;
              html += `</div>`;
            });
            // æ›´æ–°å¼¹çª—å†…å®¹
            const contentDiv = document.getElementById('lucky-content');
            if (contentDiv) contentDiv.innerHTML = html;
          }
        }
        processBatch();
      };
      actions.appendChild(btnLucky);

      // å‘¨æ˜“å‡ºå·
      const btnYijing = document.createElement('button');
      btnYijing.textContent = 'å‘¨æ˜“å‡ºå·';
      btnYijing.style.background = 'linear-gradient(90deg,#722ed1,#1890ff)';
      btnYijing.style.color = '#fff';
      btnYijing.style.fontWeight = 'bold';
      btnYijing.onclick = () => {
        showYijingDialog();
      };
      actions.appendChild(btnYijing);

      // ç„ä¹‹åˆç„
      const btnXuan = document.createElement('button');
      btnXuan.textContent = 'ç„ä¹‹åˆç„';
      btnXuan.style.background = 'linear-gradient(90deg,#111,#444)';
      btnXuan.style.color = '#fff';
      btnXuan.style.fontWeight = 'bold';
      btnXuan.onclick = () => {
        showXuanDialog();
      };
      actions.appendChild(btnXuan);

      // ç¢°æ’å‡ºå·
      const btnCollision = document.createElement('button');
      btnCollision.textContent = 'ç¢°æ’å‡ºå·';
      btnCollision.style.background = 'linear-gradient(90deg,#fa541c,#faad14)';
      btnCollision.style.color = '#fff';
      btnCollision.style.fontWeight = 'bold';
      btnCollision.onclick = () => {
        btnCollision.disabled = true;
        let collisionCount = 0;
        const cfg = configs[mode];
        const numMap = new Map();
        const totalRounds = 100;
        // å¼¹çª—ç®€ä»‹å’Œè¿›åº¦æ¡
        let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>ç¢°æ’å‡ºå·ï¼ˆ100è½®ï¼Œæ¯è½®2ä¸‡æ³¨ï¼Œç»Ÿè®¡å‡ºç°æœ€å¤šçš„å·ç ï¼‰</div>`;
        html += `<div style='font-size:15px;color:#888;margin-bottom:10px;'>æœ¬åŠŸèƒ½ç”¨äºæ¨¡æ‹Ÿå¤§è§„æ¨¡éšæœºé€‰å·ï¼Œç»Ÿè®¡åœ¨200ä¸‡æ³¨ä¸­å‡ºç°æ¬¡æ•°æœ€å¤šçš„å·ç ã€‚<br>ç¢°æ’å®Œæˆåå°†å±•ç¤ºå‡ºç°æœ€å¤šçš„å·ç åŠå…¶å‡ºç°æ¬¡æ•°ã€‚</div>`;
        html += `<div id='collision-progress-text' style='margin-bottom:4px;font-size:15px;color:#888;'>å·²å®Œæˆ 0%ï¼ˆ0/100ï¼‰</div>`;
        html += `<div id='collision-progress' style='width:100%;height:18px;background:#eee;border-radius:8px;overflow:hidden;margin-bottom:16px;position:relative;'><div id='collision-bar' style='height:100%;width:0%;background:linear-gradient(90deg,#fa541c,#faad14);transition:width 0.2s;position:absolute;left:0;top:0;'></div><div id='collision-bar-text' style='position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333;font-weight:bold;pointer-events:none;'>0%</div></div>`;
        html += `<div id='collision-result'></div>`;
        showTestResult('', null, html);

        function genNums() {
          let arr = [];
          for (let i = 0; i < 10000; i++) {
            arr.push({
              red: randomBalls(cfg.red.max, cfg.red.count),
              blue: randomBalls(cfg.blue.max, cfg.blue.count)
            });
          }
          return arr;
        }
        function numKey(num) {
          return num.red.slice().sort((a,b)=>a-b).join(',') + '|' + num.blue.slice().sort((a,b)=>a-b).join(',');
        }
        function updateProgress() {
          const percent = Math.floor(collisionCount / totalRounds * 100);
          const bar = document.getElementById('collision-bar');
          const barText = document.getElementById('collision-bar-text');
          const progText = document.getElementById('collision-progress-text');
          if (bar) bar.style.width = percent + '%';
          if (barText) barText.textContent = percent + '%';
          if (progText) progText.textContent = `å·²å®Œæˆ ${percent}%ï¼ˆ${collisionCount}/${totalRounds}ï¼‰`;
        }
        function doCollision() {
          collisionCount++;
          const groupA = genNums();
          const groupB = genNums();
          [...groupA, ...groupB].forEach(num => {
            const key = numKey(num);
            numMap.set(key, (numMap.get(key) || 0) + 1);
          });
          updateProgress();
          if (collisionCount < totalRounds) {
            setTimeout(doCollision, 0);
          } else {
            // ç»Ÿè®¡å‡ºç°æœ€å¤šçš„å·ç 
            let maxKey = '';
            let maxCount = 0;
            for (let [key, count] of numMap.entries()) {
              if (count > maxCount) {
                maxCount = count;
                maxKey = key;
              }
            }
            // è§£æå·ç 
            const [redStr, blueStr] = maxKey.split('|');
            const redArr = redStr.split(',').map(x=>parseInt(x));
            const blueArr = blueStr.split(',').map(x=>parseInt(x));
            let redHtml = redArr.map(n=>`<span style='color:#ff4d4f;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
            let blueHtml = blueArr.map(n=>`<span style='color:#1890ff;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
            let resultHtml = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>ç¢°æ’ç»Ÿè®¡å®Œæˆï¼</div>`;
            resultHtml += `<div style='margin-bottom:8px;'><b>ç¢°æ’è½®æ•°ï¼š</b><span style='color:#2d8cf0;font-weight:bold;'>${totalRounds}</span></div>`;
            resultHtml += `<div style='margin-bottom:8px;'><b>å‡ºç°æœ€å¤šçš„å·ç ï¼š</b>${redHtml} + ${blueHtml}</div>`;
            resultHtml += `<div style='margin-bottom:8px;'><b>å‡ºç°æ¬¡æ•°ï¼š</b><span style='color:#fa541c;font-weight:bold;'>${maxCount}</span> æ¬¡</div>`;
            const resultDiv = document.getElementById('collision-result');
            if (resultDiv) resultDiv.innerHTML = resultHtml;
            btnCollision.disabled = false;
          }
        }
        doCollision();
      };
      actions.appendChild(btnCollision);

      // AIç¥ç»ç½‘ç»œé€‰å·æŒ‰é’®
      const btnAINN = document.createElement('button');
      btnAINN.textContent = 'AIç¥ç»ç½‘ç»œé€‰å·';
      btnAINN.style.background = 'linear-gradient(90deg,#36cfc9,#722ed1)';
      btnAINN.style.color = '#fff';
      btnAINN.style.fontWeight = 'bold';
      function showNoDataDialog() {
        showTestResult('', null, `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;'>æ²¡æœ‰å†å²æ•°æ®ï¼Œæ— æ³•AIé€‰å·</div><div style='font-size:15px;color:#888;'>è¯·å…ˆå¯¼å…¥æˆ–å½•å…¥åŒè‰²çƒå†å²æ•°æ®ã€‚</div>`);
      }
      btnAINN.onclick = async () => {
        let historyData = [];
        let redMax, blueMax, redCount, blueCount;
        if (mode === 'ssq') {
          // åŒè‰²çƒå†å²æ•°æ®ï¼ˆ6çº¢+1è“ï¼‰
          historyData = [
            [3,6,19,27,29,33,11],[16,21,22,23,27,31,10],[1,14,21,22,23,31,12],[2,3,10,16,29,33,1],[2,14,19,24,29,33,13],
            [2,3,7,8,14,28,11],[3,12,16,19,20,32,13],[6,10,17,19,25,31,6],[2,6,8,9,10,24,11],[8,10,12,15,17,23,11],
            [6,19,20,23,26,33,9],[3,6,11,20,21,31,2],[5,11,13,16,19,32,7],[1,8,16,18,25,31,1],[5,8,13,14,24,26,12],
            [3,5,18,25,26,33,8],[3,8,10,14,16,21,3],[1,5,6,8,23,28,1],[4,6,7,30,31,33,6],[5,15,16,25,30,33,16],
            [4,9,14,15,18,25,15],[1,5,13,17,18,22,11],[4,12,15,24,30,26,7],[7,11,13,18,27,31,11],[6,13,17,22,24,29,11],
            [4,6,7,16,17,21,8],[1,9,14,16,17,25,15],[4,14,16,23,24,30,14],[6,7,9,13,21,27,5],[10,16,19,27,28,30,9],
            [3,7,17,27,29,32,4],[10,19,20,26,28,29,15],[9,12,13,15,22,26,11],[1,11,15,27,30,33,1],[5,10,16,19,27,28,9],
            [4,9,14,15,18,25,15],[1,5,13,17,18,22,11],[4,12,15,24,30,26,7],[7,11,13,18,27,31,11],[6,13,17,22,24,29,11],
            [4,6,7,16,17,21,8],[1,9,14,16,17,25,15],[4,14,16,23,24,30,14],[6,7,9,13,21,27,5],[10,16,19,27,28,30,9],
            [3,7,17,27,29,32,4],[10,19,20,26,28,29,15],[9,12,13,15,22,26,11],[1,11,15,27,30,33,1],[5,10,16,19,27,28,9],
            [4,9,14,15,18,25,15],[1,5,13,17,18,22,11],[4,12,15,24,30,26,7],[7,11,13,18,27,31,11],[6,13,17,22,24,29,11],
            [4,6,7,16,17,21,8],[1,9,14,16,17,25,15],[4,14,16,23,24,30,14],[6,7,9,13,21,27,5],[10,16,19,27,28,30,9],
            [3,7,17,27,29,32,4],[10,19,20,26,28,29,15],[9,12,13,15,22,26,11],[1,11,15,27,30,33,1],[5,10,16,19,27,28,9],
            [4,9,14,15,18,25,15],[1,5,13,17,18,22,11],[4,12,15,24,30,26,7],[7,11,13,18,27,31,11],[6,13,17,22,24,29,11],
            [4,6,7,16,17,21,8],[1,9,14,16,17,25,15],[4,14,16,23,24,30,14],[6,7,9,13,21,27,5],[10,16,19,27,28,30,9],
            [3,7,17,27,29,32,4],[10,19,20,26,28,29,15],[9,12,13,15,22,26,11],[1,11,15,27,30,33,1],[5,10,16,19,27,28,9],
            [4,9,14,15,18,25,15],[1,5,13,17,18,22,11],[4,12,15,24,30,26,7],[7,11,13,18,27,31,11],[6,13,17,22,24,29,11],
            [4,6,7,16,17,21,8],[1,9,14,16,17,25,15],[4,14,16,23,24,30,14],[6,7,9,13,21,27,5],[10,16,19,27,28,30,9]
          ];
          redMax = 33; blueMax = 16; redCount = 6; blueCount = 1;
        } else if (mode === 'dlt') {
          // å¤§ä¹é€å†å²æ•°æ®ï¼ˆ5çº¢+2è“ï¼‰
          historyData = [
            [1,5,9,14,20,5,11],[19,21,29,32,33,6,8],[1,4,9,13,17,6,9],[14,20,21,28,32,9,11],[5,11,19,22,29,2,12],
            [6,14,16,18,34,3,10],[16,17,21,31,34,3,8],[12,23,26,27,28,3,11],[1,7,8,18,28,4,12],[3,9,19,27,30,7,11],
            [5,15,24,31,34,3,10],[16,18,25,26,33,4,8],[12,27,30,34,35,5,11],[3,4,12,19,24,8,12],[1,3,6,16,25,1,11],
            [2,10,22,26,28,2,4],[1,3,9,16,19,5,11],[6,12,28,30,33,2,7],[4,12,17,23,27,2,8],[7,15,18,24,33,4,5],
            [5,6,9,15,17,3,10],[3,9,16,30,31,8,9],[2,3,7,10,25,1,11],[10,14,19,24,26,1,10],[2,10,17,28,34,7,8],
            [2,3,10,16,28,7,10],[3,7,10,29,31,1,3],[7,19,30,31,34,5,7],[11,21,25,31,32,4,10],[2,3,4,21,26,2,3],
            [5,6,10,16,31,6,9],[8,10,14,22,29,4,6],[1,4,7,13,33,5,6],[6,8,22,24,30,3,8],[1,17,20,29,34,7,8],
            [8,15,16,17,21,2,5],[5,17,20,28,34,4,9],[5,12,20,23,24,5,7],[3,6,15,23,31,1,12],[2,6,7,16,20,2,11],
            [8,21,24,33,34,3,10],[16,20,22,24,31,4,5],[6,7,8,21,30,1,5],[1,6,9,22,24,1,3],[5,20,21,22,32,3,4],
            [12,18,21,22,31,1,7],[6,9,20,32,35,8,11],[2,5,16,18,22,7,9],[4,11,23,25,34,5,7],[5,12,17,19,35,10,11],
            [1,2,7,8,31,2,10],[5,8,16,17,27,4,7],[19,21,22,28,32,6,9],[10,25,30,32,34,4,10],[2,5,9,13,33,1,7],
            [5,6,8,31,32,9,11],[3,4,13,19,35,3,10],[15,22,23,25,31,1,9],[1,5,7,13,35,5,12],[3,19,21,30,32,6,9],
            [5,21,28,30,32,7,12],[3,6,7,11,27,2,8],[2,18,19,21,25,2,11],[14,16,18,20,35,2,5],[5,19,22,29,35,2,10],
            [7,10,24,31,35,1,8],[5,7,12,20,29,8,12],[10,12,26,28,31,3,10],[1,7,9,20,28,1,4],[7,8,11,18,23,3,11],
            [1,9,12,22,29,5,9],[10,18,25,30,35,3,12],[1,11,13,27,29,4,10],[10,20,22,24,25,9,12],[6,12,13,16,23,5,8],
            [3,6,8,10,25,3,7],[2,3,7,17,30,1,9],[3,6,11,13,20,1,11],[6,8,20,25,29,3,7],[5,9,26,31,33,3,10],
            [3,9,14,24,28,6,7],[14,18,20,25,35,1,7],[12,22,25,27,28,1,2],[1,2,8,10,33,10,12],[4,15,22,28,33,6,8],
            [22,25,28,29,30,4,8],[4,7,13,27,30,2,6],[5,20,23,27,31,4,6],[7,8,20,26,34,8,9],[3,7,14,15,19,6,10],
            [2,8,16,31,32,4,12],[3,4,21,22,27,5,11],[6,8,11,18,20,5,11],[3,16,20,21,27,9,11],[15,17,21,22,26,2,8],
            [8,11,21,23,27,3,8],[4,10,15,20,34,4,7],[3,10,11,12,21,2,3],[2,6,17,23,35,6,11],[9,20,22,29,34,3,8]
          ];
          redMax = 35; blueMax = 12; redCount = 5; blueCount = 2;
        }
        if (!historyData || historyData.length < 10) {
          showNoDataDialog();
          btnAINN.disabled = false;
          btnAINN.textContent = 'AIç¥ç»ç½‘ç»œé€‰å·';
          return;
        }
        btnAINN.disabled = true;
        btnAINN.textContent = 'AIé€‰å·ä¸­...';
        // åŠ¨æ€åŠ è½½TensorFlow.js
        if (!window.tf) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js';
          document.head.appendChild(script);
          await new Promise(res => { script.onload = res; });
        }
        // æ„é€ è®­ç»ƒæ•°æ®
        const xs = [], ys = [];
        for (let i = 0; i < historyData.length - 1; i++) {
          xs.push(historyData[i]);
          ys.push(historyData[i + 1]);
        }
        const xsTensor = tf.tensor2d(xs, [xs.length, 7]);
        const ysTensor = tf.tensor2d(ys, [ys.length, 7]);
        // å»ºç«‹æ¨¡å‹
        const model = tf.sequential();
        model.add(tf.layers.dense({inputShape: [7], units: 64, activation: 'relu'}));
        model.add(tf.layers.dense({units: 64, activation: 'relu'}));
        model.add(tf.layers.dense({units: 7, activation: 'linear'}));
        model.compile({optimizer: 'adam', loss: 'meanSquaredError'});
        // è®­ç»ƒ
        await model.fit(xsTensor, ysTensor, {epochs: 120, verbose: 0});
        // ç”¨æœ€è¿‘ä¸€æœŸé¢„æµ‹ä¸‹ä¸€æœŸ
        const last = historyData[historyData.length - 1];
        const input = tf.tensor2d([last], [1, 7]);
        const pred = model.predict(input).arraySync()[0];
        // å››èˆäº”å…¥å¹¶é™åˆ¶èŒƒå›´
        let redBalls = pred.slice(0, redCount).map(n => Math.max(1, Math.min(redMax, Math.round(n))));
        let blueBalls = pred.slice(redCount, redCount+blueCount).map(n => Math.max(1, Math.min(blueMax, Math.round(n))));
        // å»é‡
        redBalls = Array.from(new Set(redBalls));
        while (redBalls.length < redCount) {
          let n = Math.floor(Math.random() * redMax) + 1;
          if (!redBalls.includes(n)) redBalls.push(n);
        }
        blueBalls = Array.from(new Set(blueBalls));
        while (blueBalls.length < blueCount) {
          let n = Math.floor(Math.random() * blueMax) + 1;
          if (!blueBalls.includes(n)) blueBalls.push(n);
        }
        userRed = redBalls.slice();
        userBlue = blueBalls.slice();
        btnAINN.disabled = false;
        btnAINN.textContent = 'AIç¥ç»ç½‘ç»œé€‰å·';
        renderGame();
      };
      // åªåœ¨å½“å‰ç©æ³•ä¸‹æ˜¾ç¤ºæŒ‰é’®
      if (mode === 'ssq' || mode === 'dlt') {
        btnAINN.disabled = false;
        actions.appendChild(btnAINN);
      }

      area.appendChild(actions);
      // å¼€å¥–åŒºï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
      const openDiv = document.createElement('div');
      openDiv.className = 'open-area';
      openDiv.innerHTML = `<b>å¼€å¥–å·ç ï¼š</b>`;
      let lot = (lotteryNumbers && lotteryNumbers[0]) ? lotteryNumbers[0] : null;
      const ballsDiv = document.createElement('div');
      ballsDiv.className = 'lottery-balls';
      if (lot) {
        lot.red.slice().sort((a,b)=>a-b).forEach(n => {
          const b = document.createElement('div');
          b.className = 'ball gold-animate red';
          b.textContent = n < 10 ? '0'+n : n;
          ballsDiv.appendChild(b);
        });
        lot.blue.slice().sort((a,b)=>a-b).forEach(n => {
          const b = document.createElement('div');
          b.className = 'ball gold-animate blue';
          b.textContent = n < 10 ? '0'+n : n;
          ballsDiv.appendChild(b);
        });
      } else {
        // æœªå¼€å¥–æ—¶æ˜¾ç¤ºç©ºçƒæˆ–æç¤º
        for (let i = 0; i < cfg.red.count; i++) {
          const b = document.createElement('div');
          b.className = 'ball red';
          b.textContent = '--';
          ballsDiv.appendChild(b);
        }
        for (let i = 0; i < cfg.blue.count; i++) {
          const b = document.createElement('div');
          b.className = 'ball blue';
          b.textContent = '--';
          ballsDiv.appendChild(b);
        }
      }
      openDiv.appendChild(ballsDiv);
      area.appendChild(openDiv);

      // å·²é€‰å·ç å±•ç¤ºï¼ˆå«ä¸­å¥–ç»“æœï¼‰
      if (userNumbers.length > 0) {
        const multiDiv = document.createElement('div');
        multiDiv.className = 'section';
        multiDiv.innerHTML = '<b>å·²é€‰å·ç ï¼š</b>';
        userNumbers.forEach((num, idx) => {
          const line = document.createElement('div');
          line.className = 'number-line';
          // æ³¨å·å‰ç¼€ï¼Œå›ºå®šå®½åº¦
          const idxSpan = document.createElement('span');
          idxSpan.textContent = `ç¬¬${idx+1}æ³¨ï¼š`;
          idxSpan.style.display = 'inline-block';
          idxSpan.style.minWidth = '60px';
          line.appendChild(idxSpan);
          // æ‰‹åŠ¨æ ‡å¿—
          if (num.manual) {
            const tag = document.createElement('span');
            tag.textContent = 'æ‰‹åŠ¨';
            tag.style.background = '#faad14';
            tag.style.color = '#fff';
            tag.style.fontSize = '13px';
            tag.style.borderRadius = '6px';
            tag.style.padding = '2px 8px';
            tag.style.marginRight = '8px';
            tag.style.marginLeft = '2px';
            tag.style.fontWeight = 'bold';
            line.appendChild(tag);
          }
          // åªç”¨æ–‡æœ¬æ˜¾ç¤ºå·ç ï¼Œçº¢åŒºçº¢å­—ï¼Œè“åŒºè“å­—
          const redText = num.red.slice().sort((a,b)=>a-b).map(n => (n < 10 ? '0'+n : n)).join(' ');
          const blueText = num.blue.slice().sort((a,b)=>a-b).map(n => (n < 10 ? '0'+n : n)).join(' ');
          const textSpan = document.createElement('span');
          textSpan.innerHTML = `<span style='color:#ff4d4f'>${redText}</span> + <span style='color:#1890ff'>${blueText}</span>`;
          textSpan.style.marginRight = '12px';
          textSpan.style.whiteSpace = 'nowrap';
          line.appendChild(textSpan);
          // åˆ é™¤æŒ‰é’®
          const delBtn = document.createElement('button');
          delBtn.textContent = 'åˆ é™¤';
          delBtn.style.marginLeft = '10px';
          delBtn.style.background = '#f5222d';
          delBtn.style.color = '#fff';
          delBtn.style.border = 'none';
          delBtn.style.borderRadius = '5px';
          delBtn.style.fontSize = '13px';
          delBtn.style.padding = '2px 10px';
          delBtn.style.cursor = 'pointer';
          delBtn.style.whiteSpace = 'nowrap';
          delBtn.onclick = () => {
            userNumbers.splice(idx, 1);
            hasDrawed = false;
            renderGame();
          };
          line.appendChild(delBtn);
          // ä¸­å¥–ç»“æœ
          let resultObj = results[idx];
          const resultSpan = document.createElement('span');
          resultSpan.innerHTML = `<b>ä¸­å¥–ç»“æœï¼š</b> <span style='font-weight:bold;'>${resultObj ? (resultObj.name + (resultObj.bonus ? 'ï¼ˆ'+resultObj.bonus+'ï¼‰' : '')) : ''}</span>`;
          resultSpan.style.whiteSpace = 'nowrap';
          line.appendChild(resultSpan);
          // æ ·å¼å¤„ç†
          if (resultObj) {
            if (resultObj.name === 'æœªä¸­å¥–') {
              line.classList.add('losing');
            } else {
              line.classList.add('winning');
            }
          }
          multiDiv.appendChild(line);
        });
        area.appendChild(multiDiv);
      }

      // å¤šæ³¨å¼€å¥–ç»“æœï¼ˆå·²åˆå¹¶åˆ°å·²é€‰å·ç åŒºï¼Œç§»é™¤åŸç»“æœåŒºï¼‰
    }

    function randomBalls(max, count) {
      const arr = Array.from({length: max}, (_,i)=>i+1);
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr.slice(0, count).sort((a,b)=>a-b);
    }

    function checkPrize(userRed, userBlue, lotteryRed, lotteryBlue) {
      const cfg = configs[mode];
      const matchRed = userRed.filter(n => lotteryRed.includes(n)).length;
      const matchBlue = userBlue.filter(n => lotteryBlue.includes(n)).length;
      for (const p of cfg.prize) {
        if (matchRed === p.matchRed && matchBlue === p.matchBlue) {
          return p;
        }
      }
      return { name: 'æœªä¸­å¥–', bonus: '' };
    }

    // ç©æ³•åˆ‡æ¢
    document.getElementById('mode-ssq').onclick = () => {
      mode = 'ssq';
      userRed = [];
      userBlue = [];
      result = null;
      document.getElementById('mode-ssq').classList.add('active');
      document.getElementById('mode-dlt').classList.remove('active');
      renderGame();
    };
    document.getElementById('mode-dlt').onclick = () => {
      mode = 'dlt';
      userRed = [];
      userBlue = [];
      result = null;
      document.getElementById('mode-dlt').classList.add('active');
      document.getElementById('mode-ssq').classList.remove('active');
      renderGame();
    };

    // æµ‹è¯•å¼€å¥–å¼¹çª—
    function showTestResult(msg, jackpotNumbers, highlight, onClose) {
      // ç§»é™¤å·²æœ‰å¼¹çª—
      const old = document.getElementById('test-modal');
      if (old) old.remove();
      const modal = document.createElement('div');
      modal.id = 'test-modal';
      modal.style.position = 'fixed';
      modal.style.left = '0';
      modal.style.top = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.25)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '9999';
      const box = document.createElement('div');
      box.style.background = '#fff';
      box.style.borderRadius = '12px';
      box.style.padding = '28px 24px 18px 24px';
      box.style.minWidth = '320px';
      box.style.maxWidth = '90vw';
      box.style.boxShadow = '0 4px 32px #0002';
      box.style.fontSize = '17px';
      box.style.lineHeight = '2';
      // å†…å®¹åŒº
      const contentDiv = document.createElement('div');
      contentDiv.id = 'lucky-content';
      contentDiv.innerHTML = highlight;
      if (jackpotNumbers) {
        let redStr = jackpotNumbers.red.sort((a,b)=>a-b).map(n=>`<span style='color:#ff4d4f;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
        let blueStr = jackpotNumbers.blue.sort((a,b)=>a-b).map(n=>`<span style='color:#1890ff;font-weight:bold;'>${n<10?'0'+n:n}</span>`).join(' ');
        const colorLine = `<div style='margin-top:8px;'><b>å¼€å¥–å·ç ï¼š</b>${redStr} + ${blueStr}</div>`;
        contentDiv.innerHTML += colorLine;
      }
      box.appendChild(contentDiv);
      // å…³é—­æŒ‰é’®
      const btn = document.createElement('button');
      btn.textContent = 'å…³é—­';
      btn.style.marginTop = '18px';
      btn.style.padding = '6px 24px';
      btn.style.background = '#2d8cf0';
      btn.style.color = '#fff';
      btn.style.border = 'none';
      btn.style.borderRadius = '6px';
      btn.style.fontSize = '16px';
      btn.style.cursor = 'pointer';
      btn.onclick = () => {
        if (onClose) onClose();
        modal.remove();
      };
      box.appendChild(btn);
      modal.appendChild(box);
      document.body.appendChild(modal);
    }

    // 64å¦è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼Œå¦è¾å’Œå‰å‡¶å¯è¡¥å……å®Œå–„ï¼‰
    const yijingHexagrams = [
      {name:'ä¹¾', desc:'å…ƒäº¨åˆ©è´ã€‚', luck:'å¤§å‰', explain:'è±¡å¾å¤©ï¼Œç§¯æè¿›å–ï¼Œä¸‡äº‹é¡ºåˆ©ã€‚'},
      {name:'å¤', desc:'å«å¼˜å…‰å¤§ï¼Œå“ç‰©å’¸äº¨ã€‚', luck:'å¤§å‰', explain:'è±¡å¾åœ°ï¼ŒåŒ…å®¹ä¸‡ç‰©ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚'},
      {name:'å±¯', desc:'å…ƒäº¨ï¼Œåˆ©è´ï¼Œå‹¿ç”¨æœ‰æ”¸å¾€ï¼Œåˆ©å»ºä¾¯ã€‚', luck:'å°å‰', explain:'ä¸‡äº‹èµ·å¤´éš¾ï¼Œéœ€è€å¿ƒç­‰å¾…æ—¶æœºã€‚'},
      {name:'è’™', desc:'äº¨ã€‚åŒªæˆ‘æ±‚ç«¥è’™ï¼Œç«¥è’™æ±‚æˆ‘ã€‚', luck:'ä¸­å¹³', explain:'å¯è’™é˜¶æ®µï¼Œå®œè™šå¿ƒå­¦ä¹ ã€‚'},
      {name:'éœ€', desc:'æœ‰å­šï¼Œå…‰äº¨ï¼Œè´å‰ã€‚', luck:'å‰', explain:'ç­‰å¾…æ—¶æœºï¼Œä¿æŒä¿¡å¿ƒã€‚'},
      {name:'è®¼', desc:'æœ‰å­šçª’æƒ•ï¼Œä¸­å‰ï¼Œç»ˆå‡¶ã€‚', luck:'å‡¶', explain:'æœ‰äº‰æ‰§ï¼Œå®œå’Œä¸ºè´µï¼Œæ…é˜²å£èˆŒã€‚'},
      {name:'å¸ˆ', desc:'è´ï¼Œä¸ˆäººå‰ï¼Œæ— å’ã€‚', luck:'å‰', explain:'æœ‰ç»„ç»‡æœ‰çºªå¾‹ï¼Œä¾é æƒå¨ã€‚'},
      {name:'æ¯”', desc:'å‰ã€‚åŸç­®ï¼Œå…ƒæ°¸è´ï¼Œæ— å’ã€‚', luck:'å‰', explain:'å›¢ç»“åä½œï¼Œäº’ç›¸å¸®åŠ©ã€‚'},
      {name:'å°ç•œ', desc:'äº¨ã€‚å¯†äº‘ä¸é›¨ï¼Œè‡ªæˆ‘è¥¿éƒŠã€‚', luck:'ä¸­å¹³', explain:'ç§¯å°‘æˆå¤šï¼Œå®œè€å¿ƒç§¯ç´¯ã€‚'},
      {name:'å±¥', desc:'å±¥è™å°¾ï¼Œä¸å’¥äººï¼Œäº¨ã€‚', luck:'å‰', explain:'å°å¿ƒè¡Œäº‹ï¼Œè°¨æ…å‰è¿›ã€‚'},
      {name:'æ³°', desc:'å°å¾€å¤§æ¥ï¼Œå‰äº¨ã€‚', luck:'å¤§å‰', explain:'å¤©åœ°äº¤æ³°ï¼Œä¸‡äº‹é¡ºé‚ã€‚'},
      {name:'å¦', desc:'å¦ä¹‹åŒªäººï¼Œä¸åˆ©å›å­è´ï¼Œå¤§å¾€å°æ¥ã€‚', luck:'å‡¶', explain:'é—­å¡ä¸é€šï¼Œå®œå®ˆé™å¾…å˜ã€‚'},
      {name:'åŒäºº', desc:'åŒäººäºé‡ï¼Œäº¨ã€‚åˆ©æ¶‰å¤§å·ï¼Œåˆ©å›å­è´ã€‚', luck:'å‰', explain:'ä¸äººä¸ºå–„ï¼Œåˆä½œå…±èµ¢ã€‚'},
      {name:'å¤§æœ‰', desc:'å…ƒäº¨ã€‚', luck:'å¤§å‰', explain:'æ”¶è·ä¸°ç››ï¼Œè´¢è¿äº¨é€šã€‚'},
      {name:'è°¦', desc:'äº¨ï¼Œå›å­æœ‰ç»ˆã€‚', luck:'å‰', explain:'è°¦è™šè°¨æ…ï¼Œç¦æ³½è‡ªæ¥ã€‚'},
      {name:'è±«', desc:'åˆ©å»ºä¾¯ï¼Œè¡Œå¸ˆã€‚', luck:'å‰', explain:'å¿ƒæƒ…æ„‰å¿«ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚'},
      {name:'éš', desc:'å…ƒäº¨åˆ©è´ï¼Œæ— å’ã€‚', luck:'å‰', explain:'é¡ºåº”å˜åŒ–ï¼Œçµæ´»åº”å¯¹ã€‚'},
      {name:'è›Š', desc:'å…ƒäº¨ï¼Œåˆ©æ¶‰å¤§å·ã€‚å…ˆç”²ä¸‰æ—¥ï¼Œåç”²ä¸‰æ—¥ã€‚', luck:'ä¸­å¹³', explain:'æ”¹é©åˆ›æ–°ï¼Œå»æ—§è¿æ–°ã€‚'},
      {name:'ä¸´', desc:'å…ƒäº¨åˆ©è´ã€‚è‡³äºå…«æœˆæœ‰å‡¶ã€‚', luck:'å‰', explain:'å±…é«˜ä¸´ä¸‹ï¼Œå®œè°¦è™šè°¨æ…ã€‚'},
      {name:'è§‚', desc:'ç›¥è€Œä¸èï¼Œæœ‰å­šé¡’è‹¥ã€‚', luck:'ä¸­å¹³', explain:'è§‚å¯Ÿå½¢åŠ¿ï¼Œé™è§‚å…¶å˜ã€‚'},
      {name:'å™¬å—‘', desc:'äº¨ã€‚åˆ©ç”¨ç‹±ã€‚', luck:'ä¸­å¹³', explain:'è§£å†³éšœç¢ï¼Œå®œæœæ–­å¤„ç†ã€‚'},
      {name:'è´²', desc:'äº¨ã€‚å°åˆ©æœ‰æ”¸å¾€ã€‚', luck:'å‰', explain:'å¤–è¡¨ç¾å¥½ï¼Œå†…åœ¨éœ€å……å®ã€‚'},
      {name:'å‰¥', desc:'ä¸åˆ©æœ‰æ”¸å¾€ã€‚', luck:'å‡¶', explain:'äº‹ç‰©å‰¥è½ï¼Œå®œé˜²æŸå¤±ã€‚'},
      {name:'å¤', desc:'äº¨ã€‚å‡ºå…¥æ— ç–¾ï¼Œæœ‹æ¥æ— å’ã€‚', luck:'å‰', explain:'å¤±è€Œå¤å¾—ï¼Œé‡è·æ–°ç”Ÿã€‚'},
      {name:'æ— å¦„', desc:'å…ƒäº¨åˆ©è´ã€‚å…¶åŒªæ­£æœ‰çœšï¼Œä¸åˆ©æœ‰æ”¸å¾€ã€‚', luck:'å‡¶', explain:'æ„å¤–ä¹‹äº‹ï¼Œå®œå®ˆæ­£é“ã€‚'},
      {name:'å¤§ç•œ', desc:'åˆ©è´ã€‚ä¸å®¶é£Ÿå‰ã€‚åˆ©æ¶‰å¤§å·ã€‚', luck:'å‰', explain:'ç§¯è“„åŠ›é‡ï¼Œç­‰å¾…æ—¶æœºã€‚'},
      {name:'é¢', desc:'è´å‰ã€‚è§‚é¢ï¼Œè‡ªæ±‚å£å®ã€‚', luck:'å‰', explain:'æ³¨é‡å…»ç”Ÿï¼Œé¥®é£Ÿæœ‰èŠ‚ã€‚'},
      {name:'å¤§è¿‡', desc:'æ ‹æ¡¡ï¼Œåˆ©æœ‰æ”¸å¾€ï¼Œäº¨ã€‚', luck:'ä¸­å¹³', explain:'å‹åŠ›è¾ƒå¤§ï¼Œå®œé‡åŠ›è€Œè¡Œã€‚'},
      {name:'å', desc:'ä¹ åï¼Œæœ‰å­šï¼Œç»´å¿ƒäº¨ï¼Œè¡Œæœ‰å°šã€‚', luck:'å‡¶', explain:'å¤šæœ‰é˜»ç¢ï¼Œéœ€è°¨æ…å‰è¡Œã€‚'},
      {name:'ç¦»', desc:'åˆ©è´ï¼Œäº¨ã€‚ç•œç‰ç‰›å‰ã€‚', luck:'å‰', explain:'å…‰æ˜æ­£å¤§ï¼Œå‰é€”å…‰æ˜ã€‚'},
      {name:'å’¸', desc:'äº¨ï¼Œåˆ©è´ã€‚å–å¥³å‰ã€‚', luck:'å‰', explain:'æ„Ÿåº”è‰¯å¥½ï¼Œé€‚åˆæ‹çˆ±ã€‚'},
      {name:'æ’', desc:'äº¨ï¼Œæ— å’ï¼Œåˆ©è´ï¼Œåˆ©æœ‰æ”¸å¾€ã€‚', luck:'å‰', explain:'æŒä¹‹ä»¥æ’ï¼Œç»ˆè·æˆåŠŸã€‚'},
      {name:'é', desc:'äº¨ï¼Œå°åˆ©è´ã€‚', luck:'ä¸­å¹³', explain:'é€€é¿ä¸‰èˆï¼Œæš‚é¿é”‹èŠ’ã€‚'},
      {name:'å¤§å£®', desc:'åˆ©è´ã€‚', luck:'å‰', explain:'åŠ›é‡å¢å¼ºï¼Œç§¯æè¿›å–ã€‚'},
      {name:'æ™‹', desc:'åº·ä¾¯ç”¨é”¡é©¬è•ƒåº¶ï¼Œæ˜¼æ—¥ä¸‰æ¥ã€‚', luck:'å‰', explain:'æ­¥æ­¥é«˜å‡ï¼Œäº‹ä¸šæœ‰æˆã€‚'},
      {name:'æ˜å¤·', desc:'åˆ©è‰°è´ã€‚', luck:'å‡¶', explain:'å…‰æ˜å—æŸï¼Œå®œè‡ªæˆ‘ä¿æŠ¤ã€‚'},
      {name:'å®¶äºº', desc:'åˆ©å¥³è´ã€‚', luck:'å‰', explain:'å®¶åº­å’Œç¦ï¼Œäº²æƒ…ä¸ºé‡ã€‚'},
      {name:'ç½', desc:'å°äº‹å‰ã€‚', luck:'ä¸­å¹³', explain:'åˆ†æ­§çŸ›ç›¾ï¼Œæ±‚åŒå­˜å¼‚ã€‚'},
      {name:'è¹‡', desc:'åˆ©è¥¿å—ï¼Œä¸åˆ©ä¸œåŒ—ã€‚åˆ©è§å¤§äººï¼Œè´å‰ã€‚', luck:'ä¸­å¹³', explain:'å‰è·¯è‰°éš¾ï¼Œéœ€å¯»æ±‚å¸®åŠ©ã€‚'},
      {name:'è§£', desc:'åˆ©è¥¿å—ï¼Œæ— å’ã€‚', luck:'å‰', explain:'å›°å¢ƒè§£é™¤ï¼Œé—®é¢˜è¿åˆƒè€Œè§£ã€‚'},
      {name:'æŸ', desc:'æœ‰å­šï¼Œå…ƒå‰ï¼Œæ— å’ï¼Œå¯è´ï¼Œåˆ©æœ‰æ”¸å¾€ã€‚', luck:'å‰', explain:'é€‚å½“èˆå¼ƒï¼Œåå¾—å¤§åˆ©ã€‚'},
      {name:'ç›Š', desc:'åˆ©æœ‰æ”¸å¾€ï¼Œåˆ©æ¶‰å¤§å·ã€‚', luck:'å‰', explain:'æœ‰æ‰€æ”¶è·ï¼Œåˆ©äºå‰è¡Œã€‚'},
      {name:'å¤¬', desc:'æ‰¬äºç‹åº­ï¼Œå­šå·æœ‰å‰ã€‚', luck:'å‡¶', explain:'æœæ–­å†³ç­–ï¼Œé˜²èŒƒé£é™©ã€‚'},
      {name:'å§¤', desc:'å¥³å£®ï¼Œå‹¿ç”¨å–å¥³ã€‚', luck:'å‡¶', explain:'å¶é‡çªå‘ï¼Œå®œè°¨æ…åº”å¯¹ã€‚'},
      {name:'èƒ', desc:'äº¨ï¼Œç‹å‡æœ‰åº™ï¼Œåˆ©è§å¤§äººï¼Œåˆ©è´ã€‚', luck:'å‰', explain:'ä¼—äººèšé›†ï¼ŒåˆåŠ›æˆäº‹ã€‚'},
      {name:'å‡', desc:'å…ƒäº¨ï¼Œç”¨è§å¤§äººï¼Œå‹¿æ¤ï¼Œå—å¾å‰ã€‚', luck:'å‰', explain:'æ­¥æ­¥é«˜å‡ï¼Œå®œæŠŠæ¡æœºä¼šã€‚'},
      {name:'å›°', desc:'äº¨ï¼Œè´ï¼Œå¤§äººå‰ï¼Œæ— å’ï¼Œæœ‰è¨€ä¸ä¿¡ã€‚', luck:'å‡¶', explain:'å¤„å¢ƒå›°é¡¿ï¼Œéœ€åšå®ˆä¿¡å¿µã€‚'},
      {name:'äº•', desc:'æ”¹é‚‘ä¸æ”¹äº•ï¼Œæ— ä¸§æ— å¾—ã€‚å¾€æ¥äº•äº•ã€‚', luck:'ä¸­å¹³', explain:'åŸºç¡€ç¨³å›ºï¼Œå®œå®ˆæˆã€‚'},
      {name:'é©', desc:'å·±æ—¥ä¹ƒå­šã€‚å…ƒäº¨åˆ©è´ï¼Œæ‚”äº¡ã€‚', luck:'å‰', explain:'å˜é©åˆ›æ–°ï¼Œå»æ—§è¿æ–°ã€‚'},
      {name:'é¼', desc:'å…ƒå‰ï¼Œäº¨ã€‚', luck:'å‰', explain:'é¼æ–°é©æ•…ï¼Œäº‹ä¸šæœ‰æˆã€‚'},
      {name:'éœ‡', desc:'äº¨ï¼Œéœ‡æ¥è™©è™©ï¼Œç¬‘è¨€å“‘å“‘ï¼Œéœ‡æƒŠç™¾é‡Œï¼Œä¸ä¸§åŒ•é¬¯ã€‚', luck:'å‰', explain:'è¡ŒåŠ¨è¿…é€Ÿï¼Œæœæ–­æœ‰ä¸ºã€‚'},
      {name:'è‰®', desc:'è‰®å…¶èƒŒï¼Œä¸è·å…¶èº«ï¼Œè¡Œå…¶åº­ï¼Œä¸è§å…¶äººï¼Œæ— å’ã€‚', luck:'ä¸­å¹³', explain:'æ­¢æ­¥è§‚æœ›ï¼Œå®œé™ä¸å®œåŠ¨ã€‚'},
      {name:'æ¸', desc:'å¥³å½’å‰ï¼Œåˆ©è´ã€‚', luck:'å‰', explain:'å¾ªåºæ¸è¿›ï¼Œæ°´åˆ°æ¸ æˆã€‚'},
      {name:'å½’å¦¹', desc:'å¾å‡¶ï¼Œæ— æ”¸åˆ©ã€‚', luck:'å‡¶', explain:'å©šå§»ä¹‹äº‹ï¼Œéœ€è°¨æ…å¯¹å¾…ã€‚'},
      {name:'ä¸°', desc:'äº¨ï¼Œç‹å‡ä¹‹ï¼Œå‹¿å¿§ï¼Œå®œæ—¥ä¸­ã€‚', luck:'å‰', explain:'æ”¶è·ä¸°å¯Œï¼Œå®œçæƒœå½“ä¸‹ã€‚'},
      {name:'æ—…', desc:'å°äº¨ï¼Œæ—…è´å‰ã€‚', luck:'å‰', explain:'å¤–å‡ºæ—…è¡Œï¼Œæ³¨æ„å®‰å…¨ã€‚'},
      {name:'å·½', desc:'å°äº¨ï¼Œåˆ©æœ‰æ”¸å¾€ï¼Œåˆ©è§å¤§äººã€‚', luck:'å‰', explain:'è°¦é€Šæœ‰ç¤¼ï¼Œåˆ©äºè¿›æ­¥ã€‚'},
      {name:'å…‘', desc:'äº¨ï¼Œåˆ©è´ã€‚', luck:'å‰', explain:'å’Œæ‚¦å¾…äººï¼Œå£æ‰å‡ºä¼—ã€‚'},
      {name:'æ¶£', desc:'äº¨ã€‚ç‹å‡æœ‰åº™ï¼Œåˆ©æ¶‰å¤§å·ï¼Œåˆ©è´ã€‚', luck:'å‰', explain:'åˆ†æ•£èšåˆï¼Œé¡ºåŠ¿è€Œä¸ºã€‚'},
      {name:'èŠ‚', desc:'äº¨ï¼Œè‹¦èŠ‚ä¸å¯è´ã€‚', luck:'ä¸­å¹³', explain:'èŠ‚åˆ¶æœ‰åº¦ï¼Œè¿‡çŠ¹ä¸åŠã€‚'},
      {name:'ä¸­å­š', desc:'è±šé±¼å‰ï¼Œåˆ©æ¶‰å¤§å·ï¼Œåˆ©è´ã€‚', luck:'å‰', explain:'è¯šä¿¡ä¸ºæœ¬ï¼Œå‰ç¥¥å¦‚æ„ã€‚'},
      {name:'å°è¿‡', desc:'äº¨ï¼Œåˆ©è´ï¼Œå¯å°äº‹ï¼Œä¸å¯å¤§äº‹ã€‚é£é¸Ÿé—ä¹‹éŸ³ï¼Œä¸å®œä¸Šï¼Œå®œä¸‹ï¼Œå¤§å‰ã€‚', luck:'å‰', explain:'å°äº‹å¯æˆï¼Œå¤§äº‹éš¾å°±ã€‚'},
      {name:'æ—¢æµ', desc:'äº¨å°ï¼Œåˆ©è´ï¼Œåˆå‰ç»ˆä¹±ã€‚', luck:'ä¸­å¹³', explain:'äº‹æƒ…å·²æˆï¼Œæ…é˜²åå˜ã€‚'},
      {name:'æœªæµ', desc:'äº¨ï¼Œè‹¦èŠ‚ä¸å¯è´ã€‚', luck:'å‡¶', explain:'å°šæœªå®Œæˆï¼Œéœ€å†åŠªåŠ›ã€‚'},
    ];
    function randomYijingLines() {
      // ç»“åˆå½“å‰æ—¶é—´æˆ³å’Œéšæœºç”Ÿæˆå…­ä¸ªçˆ»ï¼ˆ0=é˜´ï¼Œ1=é˜³ï¼‰ï¼Œè‡ªä¸‹è€Œä¸Š
      const now = Date.now();
      // å–æ¯«ç§’çš„ä½6ä½ä½œä¸ºéƒ¨åˆ†çˆ»
      const ms = now & 0b111111;
      let lines = [];
      for (let i = 0; i < 6; i++) {
        // ä½ä¸‰ä½ç”¨æ—¶é—´ï¼Œåä¸‰ä½ç”¨éšæœº
        if (i < 3) {
          lines.push((ms >> i) & 1);
        } else {
          lines.push(Math.random() > 0.5 ? 1 : 0);
        }
      }
      return lines;
    }
    function linesToHexIndex(lines) {
      // lines: [ä¸‹, ..., ä¸Š]ï¼Œè½¬ä¸ºäºŒè¿›åˆ¶åºå·
      return parseInt(lines.slice().reverse().join(''),2);
    }
    function yijingToNumbers(lines, redMax, redCount, blueMax, blueCount) {
      // ç”¨å¦åºå·+çˆ»åˆ†å¸ƒæ˜ å°„å·ç 
      let base = linesToHexIndex(lines);
      let reds = [];
      for (let i = 0; i < redCount; i++) {
        reds.push((base + i*3 + lines[i%6]*7) % redMax + 1);
      }
      let blues = [];
      for (let i = 0; i < blueCount; i++) {
        blues.push((base + i*7 + lines[(i+2)%6]*5) % blueMax + 1);
      }
      // ä¿è¯ä¸é‡å¤
      reds = Array.from(new Set(reds));
      while (reds.length < redCount) {
        let n = Math.floor(Math.random()*redMax)+1;
        if (!reds.includes(n)) reds.push(n);
      }
      blues = Array.from(new Set(blues));
      while (blues.length < blueCount) {
        let n = Math.floor(Math.random()*blueMax)+1;
        if (!blues.includes(n)) blues.push(n);
      }
      return {red: reds, blue: blues};
    }
    function showYijingDialog() {
      const cfg = configs[mode];
      let customInfo = window.YIJING_USER_INFO
        ? { ...window.YIJING_USER_INFO }
        : { name: '', birthday: '', lucky: '', blood: '' };
      let lastInfo = { ...customInfo };

      function getCustomSeed() {
        let seed = Date.now();
        if (customInfo.name) {
          for (let c of customInfo.name) seed += c.charCodeAt(0);
        }
        if (customInfo.birthday) {
          seed += new Date(customInfo.birthday).getTime();
        }
        if (customInfo.lucky) {
          seed += parseInt(customInfo.lucky) || 0;
        }
        if (customInfo.blood) {
          // è¡€å‹A=1,B=2,AB=3,O=4
          const bloodMap = {A:1,B:2,AB:3,O:4};
          seed += bloodMap[customInfo.blood] || 0;
        }
        return seed;
      }

      function randomYijingLinesCustom() {
        // ç”¨è‡ªå®šä¹‰seedå½±å“å…­çˆ»
        let seed = getCustomSeed();
        let lines = [];
        for (let i = 0; i < 6; i++) {
          seed = (seed * 9301 + 49297) % 233280;
          lines.push((seed >> (i % 8)) & 1);
        }
        return lines;
      }

      function isInfoChanged() {
        return customInfo.name !== lastInfo.name || customInfo.birthday !== lastInfo.birthday || customInfo.lucky !== lastInfo.lucky || customInfo.blood !== lastInfo.blood;
      }

      function getConstellation(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const m = d.getMonth() + 1, day = d.getDate();
        // æ ‡å‡†æ˜Ÿåº§æ—¥æœŸåŒºé—´
        const arr = [
          ['æ‘©ç¾¯åº§', 1, 1, 1, 19],
          ['æ°´ç“¶åº§', 1, 20, 2, 18],
          ['åŒé±¼åº§', 2, 19, 3, 20],
          ['ç™½ç¾Šåº§', 3, 21, 4, 19],
          ['é‡‘ç‰›åº§', 4, 20, 5, 20],
          ['åŒå­åº§', 5, 21, 6, 21],
          ['å·¨èŸ¹åº§', 6, 22, 7, 22],
          ['ç‹®å­åº§', 7, 23, 8, 22],
          ['å¤„å¥³åº§', 8, 23, 9, 22],
          ['å¤©ç§¤åº§', 9, 23, 10, 23],
          ['å¤©èåº§', 10, 24, 11, 22],
          ['å°„æ‰‹åº§', 11, 23, 12, 21],
          ['æ‘©ç¾¯åº§', 12, 22, 12, 31]
        ];
        for (let i = 0; i < arr.length; i++) {
          const [name, sm, sd, em, ed] = arr[i];
          if ((m === sm && day >= sd) || (m === em && day <= ed)) return name;
        }
        return '';
      }
      function getFavColor(lucky, blood) {
        // æ‰©å±•ä¸º26è‰²ï¼Œå«ç™½è‰²å’Œé»‘è‰²
        if (!lucky && !blood) return '';
        const colors = [
          '#ff4d4f', '#faad14', '#52c41a', '#1890ff', '#722ed1', '#13c2c2', '#eb2f96', '#a0a0a0',
          '#f5222d', '#fa541c', '#fa8c16', '#fae004', '#b7eb8f', '#36cfc9', '#40a9ff', '#597ef7',
          '#9254de', '#f759ab', '#d3adf7', '#ff85c0', '#ffd666', '#ffc069', '#ffec3d', '#bae637',
          '#000000', '#ffffff'
        ];
        const bloodMap = {A:1,B:2,AB:3,O:4};
        let idx = (parseInt(lucky)||0) + (bloodMap[blood]||0);
        return colors[idx % colors.length];
      }
      function getFavColorName(hex) {
        // 26è‰²å
        if (!hex) return '';
        const map = {
          '#ff4d4f':'æ­£çº¢','#faad14':'ç¥ç€','#52c41a':'ç¿ ç»¿','#1890ff':'å¤©è“','#722ed1':'ç´«ç½—å…°','#13c2c2':'é’ç»¿',
          '#eb2f96':'ç«çº¢','#a0a0a0':'ä¸­ç°','#f5222d':'çŒ©çº¢','#fa541c':'æ©˜çº¢','#fa8c16':'æ©™é»„','#fae004':'æŸ æª¬é»„',
          '#b7eb8f':'å«©ç»¿','#36cfc9':'è–„è·','#40a9ff':'æ¹–è“','#597ef7':'é›è“','#9254de':'æ·¡ç´«','#f759ab':'ç²‰ç´«',
          '#d3adf7':'è–°è¡£è‰','#ff85c0':'æ¨±èŠ±ç²‰','#ffd666':'æµ…é‡‘','#ffc069':'æé»„','#ffec3d':'äº®é»„','#bae637':'è‹¹æœç»¿',
          '#000000':'é»‘è‰²','#ffffff':'ç™½è‰²'
        };
        return map[hex]||'å½©è‰²';
      }
      function getWorry(blood, constellation, lucky) {
        // ä¸°å¯Œçš„é¡¾è™‘åº“
        const worries = [
          'æ‹…å¿ƒé”™è¿‡æœºä¼š', 'å®³æ€•è¿æ°”ä¸ä½³', 'æ‹…å¿ƒè®¡åˆ’èµ¶ä¸ä¸Šå˜åŒ–', 'å®³æ€•è¢«è¯¯è§£', 'æ‹…å¿ƒåŠªåŠ›æ²¡æœ‰å›æŠ¥',
          'å®³æ€•å­¤ç‹¬', 'æ‹…å¿ƒå¥åº·é—®é¢˜', 'æ‹…å¿ƒè´¢åŠ¡å‹åŠ›', 'æ‹…å¿ƒäººé™…å…³ç³»', 'æ‹…å¿ƒæœªæ¥ä¸ç¡®å®š',
          'æ‹…å¿ƒæ— æ³•åšæŒ', 'æ‹…å¿ƒè¢«å¿½è§†', 'æ‹…å¿ƒé€‰æ‹©é”™è¯¯', 'æ‹…å¿ƒå¤±å»è‡ªç”±', 'æ‹…å¿ƒæ²¡æœ‰å®‰å…¨æ„Ÿ',
          'æ‹…å¿ƒè¢«æ¯”è¾ƒ', 'æ‹…å¿ƒæ‹–å»¶ç—‡', 'æ‹…å¿ƒè¡¨è¾¾ä¸æ¸…', 'æ‹…å¿ƒæ²¡æœ‰åŠ¨åŠ›', 'æ‹…å¿ƒè¢«æ‹’ç»',
          'æ‹…å¿ƒç›®æ ‡å¤ªé«˜éš¾ä»¥å®ç°', 'æ‹…å¿ƒå®¶åº­ä¸å’Œç¦', 'æ‹…å¿ƒæœ‹å‹ç–è¿œ', 'æ‹…å¿ƒå·¥ä½œå‹åŠ›å¤§', 'æ‹…å¿ƒäº‹ä¸šåœæ»',
          'æ‹…å¿ƒå­¦ä¹ è·Ÿä¸ä¸Š', 'æ‹…å¿ƒæŠ€æœ¯è½å', 'æ‹…å¿ƒè¢«æ·˜æ±°', 'æ‹…å¿ƒæ²¡æœ‰åˆ›æ–°', 'æ‹…å¿ƒç¼ºä¹èµ„æº',
          'æ‹…å¿ƒèº«ä½“å‘èƒ–', 'æ‹…å¿ƒå¤±çœ å¤šæ¢¦', 'æ‹…å¿ƒé¥®é£Ÿä¸å¥åº·', 'æ‹…å¿ƒè¿åŠ¨ä¸è¶³', 'æ‹…å¿ƒæ„å¤–å—ä¼¤',
          'æ‹…å¿ƒç¯å¢ƒæ±¡æŸ“', 'æ‹…å¿ƒäº¤é€šå®‰å…¨', 'æ‹…å¿ƒå¤©æ°”å˜åŒ–', 'æ‹…å¿ƒè‡ªç„¶ç¾å®³', 'æ‹…å¿ƒç–¾ç—…æµè¡Œ',
          'æ‹…å¿ƒäº²äººå¥åº·', 'æ‹…å¿ƒå­å¥³æ•™è‚²', 'æ‹…å¿ƒçˆ¶æ¯å¹´è€', 'æ‹…å¿ƒå®¶åº­ç»æµ', 'æ‹…å¿ƒä½æˆ¿é—®é¢˜',
          'æ‹…å¿ƒä¹°ä¸èµ·æˆ¿', 'æ‹…å¿ƒç§Ÿæˆ¿ä¸ç¨³å®š', 'æ‹…å¿ƒç‰©ä»·ä¸Šæ¶¨', 'æ‹…å¿ƒæ”¶å…¥å‡å°‘', 'æ‹…å¿ƒæŠ•èµ„å¤±è´¥',
          'æ‹…å¿ƒç†è´¢è¢«éª—', 'æ‹…å¿ƒå€ºåŠ¡ç¼ èº«', 'æ‹…å¿ƒä¿¡ç”¨å—æŸ', 'æ‹…å¿ƒå¤±ä¸šé£é™©', 'æ‹…å¿ƒèŒä¸šå‘å±•',
          'æ‹…å¿ƒå‡èŒæ— æœ›', 'æ‹…å¿ƒåŒäº‹å…³ç³»', 'æ‹…å¿ƒé¢†å¯¼ä¸èµè¯†', 'æ‹…å¿ƒå·¥ä½œæ— è¶£', 'æ‹…å¿ƒåŠ ç­å¤ªå¤š',
          'æ‹…å¿ƒå‡æœŸå¤ªå°‘', 'æ‹…å¿ƒä¼‘æ¯ä¸è¶³', 'æ‹…å¿ƒç”Ÿæ´»å•è°ƒ', 'æ‹…å¿ƒç¼ºä¹æ¿€æƒ…', 'æ‹…å¿ƒå…´è¶£ä¸§å¤±',
          'æ‹…å¿ƒæ²¡æœ‰æœ‹å‹', 'æ‹…å¿ƒç¤¾äº¤ææƒ§', 'æ‹…å¿ƒè¡¨è¾¾èƒ½åŠ›å·®', 'æ‹…å¿ƒæ²Ÿé€šéšœç¢', 'æ‹…å¿ƒè¢«å­¤ç«‹',
          'æ‹…å¿ƒæ‹çˆ±å¤±è´¥', 'æ‹…å¿ƒå©šå§»ä¸å¹¸ç¦', 'æ‹…å¿ƒæ„Ÿæƒ…å˜æ·¡', 'æ‹…å¿ƒè¢«èƒŒå›', 'æ‹…å¿ƒåˆ†æ‰‹ç—›è‹¦',
          'æ‹…å¿ƒé‡äººä¸æ·‘', 'æ‹…å¿ƒå•èº«å¤ªä¹…', 'æ‹…å¿ƒå®¶åº­æš´åŠ›', 'æ‹…å¿ƒå­å¥³å›é€†', 'æ‹…å¿ƒæ•™è‚²æ–¹å¼',
          'æ‹…å¿ƒå­©å­æˆç»©', 'æ‹…å¿ƒå­©å­å¥åº·', 'æ‹…å¿ƒå­©å­äº¤å‹', 'æ‹…å¿ƒå­©å­å®‰å…¨', 'æ‹…å¿ƒå­©å­æœªæ¥',
          'æ‹…å¿ƒè€æ— æ‰€ä¾', 'æ‹…å¿ƒå…»è€é—®é¢˜', 'æ‹…å¿ƒåŒ»ç–—è´¹ç”¨', 'æ‹…å¿ƒé€€ä¼‘ç”Ÿæ´»', 'æ‹…å¿ƒç¤¾ä¼šä¿éšœ',
          'æ‹…å¿ƒæ”¿ç­–å˜åŒ–', 'æ‹…å¿ƒæ³•å¾‹é£é™©', 'æ‹…å¿ƒåˆåŒçº çº·', 'æ‹…å¿ƒè¢«è¯ˆéª—', 'æ‹…å¿ƒç½‘ç»œå®‰å…¨',
          'æ‹…å¿ƒéšç§æ³„éœ²', 'æ‹…å¿ƒä¿¡æ¯è¿‡è½½', 'æ‹…å¿ƒæŠ€æœ¯å¤±æ§', 'æ‹…å¿ƒäººå·¥æ™ºèƒ½å¨èƒ', 'æ‹…å¿ƒä¸–ç•Œå’Œå¹³'
        ];
        // ä¿¡æ¯hash
        let idx = 0;
        if (blood) idx += {A:1, B:2, AB:3, O:4}[blood] * 3;
        if (constellation) idx += constellation.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
        if (lucky) idx += parseInt(lucky) * 7;
        if (!blood && !constellation && !lucky) {
          // ä¿¡æ¯å…¨æ— ï¼Œè¿”å›'æš‚æ— '
          return 'æš‚æ— ';
        } else {
          idx = idx % worries.length;
        }
        return worries[idx];
      }

      function genResult() {
        const now = new Date();
        const lines = randomYijingLinesCustom();
        const idx = linesToHexIndex(lines) % 64;
        const hex = yijingHexagrams[idx];
        const nums = yijingToNumbers(lines, cfg.red.max, cfg.red.count, cfg.blue.max, cfg.blue.count);
        // å¦è±¡å›¾ï¼ˆæ¨ªå‘ç´§å‡‘ï¼‰
        let linesHtml = lines.slice().reverse().map(v =>
          v
            ? '<span style="font-size:22px;margin:0 2px;color:#1890ff;">âšŠ</span>'
            : '<span style="font-size:22px;margin:0 2px;color:#888;">âš‹</span>'
        ).join('');
        // å·ç 
        let redHtml = nums.red.slice().sort((a,b)=>a-b).map(n=>`<span style='color:#ff4d4f;font-weight:bold;font-size:18px;'>${n<10?'0'+n:n}</span>`).join(' ');
        let blueHtml = nums.blue.slice().sort((a,b)=>a-b).map(n=>`<span style='color:#1890ff;font-weight:bold;font-size:18px;'>${n<10?'0'+n:n}</span>`).join(' ');
        // æ—¶é—´å­—ç¬¦ä¸²
        let timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ` +
                      `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}.${now.getMilliseconds().toString().padStart(3,'0')}`;
        // ä¸ªäººä¿¡æ¯è¡¨å•ï¼ˆåŠ idä¾¿äºåª’ä½“æŸ¥è¯¢é€‚é…ï¼‰
        let formHtml = `<div id='yijing-form-row' style='margin-bottom:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;'>`
          + `<label>å§“åï¼š<input id='yijing-name' type='text' value='${customInfo.name||''}' style='width:80px;margin-right:8px;'></label>`
          + `<label>ç”Ÿæ—¥ï¼š<input id='yijing-birthday' type='date' value='${customInfo.birthday||''}' style='margin-right:8px;'></label>`
          + `<label>å¹¸è¿æ•°å­—ï¼š<input id='yijing-lucky' type='number' value='${customInfo.lucky||''}' style='width:60px;'></label>`
          + `<label>è¡€å‹ï¼š<select id='yijing-blood' style='width:60px;'><option value=''>--</option><option value='A'${customInfo.blood==='A'?' selected':''}>A</option><option value='B'${customInfo.blood==='B'?' selected':''}>B</option><option value='AB'${customInfo.blood==='AB'?' selected':''}>AB</option><option value='O'${customInfo.blood==='O'?' selected':''}>O</option></select></label>`
          + `<button id='yijing-setinfo' style='margin-left:8px;background:${isInfoChanged() ? '#1890ff' : '#ccc'};color:#fff;border:none;border-radius:6px;padding:4px 14px;font-size:15px;cursor:${isInfoChanged() ? 'pointer' : 'not-allowed'};' ${isInfoChanged() ? '' : 'disabled'}>ç¡®å®š</button>`
          + `</div>`;
        // å¤´éƒ¨ä¿¡æ¯
        let headInfo = '';
        let constellation = getConstellation(customInfo.birthday);
        let favColorHex = getFavColor(customInfo.lucky, customInfo.blood);
        let favColorName = getFavColorName(favColorHex);
        let worry = getWorry(customInfo.blood, constellation, customInfo.lucky);
        if (customInfo.name || constellation || favColorName || worry) {
          headInfo = `<div style='font-size:15px;color:#888;margin-bottom:4px;'>` +
            (customInfo.name ? `<span style='color:#2d8cf0;font-weight:bold;'>${customInfo.name}</span> ` : '') +
            (constellation ? `| æ˜Ÿåº§ï¼š<span style='color:#faad14;'>${constellation}</span> ` : '') +
            `| å–œæ¬¢çš„é¢œè‰²ï¼š<span style='color:${favColorHex||'#aaa'};font-weight:bold;'>${favColorName||'æš‚æ— '}</span> ` +
            `| å½“å‰çš„é¡¾è™‘ï¼š<span style='color:#eb2f96;'>${worry==='æš‚æ— '?'æš‚æ— ':worry}</span>` +
            `</div>`;
        }
        // å†…å®¹
        let html = formHtml;
        html += `<div style='font-size:18px;font-weight:bold;margin-bottom:8px;'>å‘¨æ˜“å‡ºå·${customInfo.name ? ' - ' + customInfo.name : ''}</div>`;
        html += headInfo;
        html += `<div style='font-size:15px;color:#888;margin-bottom:6px;'>æœ¬æ¬¡ç‚¹å‡»æ—¶é—´ï¼š<span style='color:#2d8cf0;font-weight:bold;'>${timeStr}</span></div>`;
        html += `<div style='display:flex;gap:18px;align-items:center;margin-bottom:10px;'><div>${linesHtml}</div><div><div style='font-size:17px;font-weight:bold;'>${hex.name}å¦<span style='font-size:14px;color:#888;font-weight:normal;'>ï¼ˆ${hex.explain}ï¼‰</span></div><div style='font-size:15px;color:#888;'>${hex.desc}</div><div style='font-size:15px;color:#faad14;font-weight:bold;'>å‰å‡¶ï¼š${hex.luck}</div></div></div>`;
        html += `<div style='margin-bottom:10px;'><b>æœ¬å¦é€‰å·ï¼š</b><span>${redHtml} + ${blueHtml}</span></div>`;
        html += `<div style='font-size:14px;color:#888;margin-bottom:8px;'>ä»…ä¾›å¨±ä¹ï¼Œç¥å›å¥½è¿ï¼ï¼ˆå¦‚éœ€ç»“åˆä½¿ç”¨è€…å‘½æ ¼ä¹‹é«˜é˜¶åº”ç”¨è¯·è”ç³»ç‰ˆæƒæ‰€æœ‰äººï¼‰</div>`;
        html += `<div style='text-align:right;'><button id='yijing-again' style='background:#722ed1;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:15px;cursor:pointer;'>å†æ‘‡ä¸€æ¬¡</button></div>`;
        return html;
      }
      function show() {
        showTestResult('', null, genResult());
        setTimeout(()=>{
          // ä¸ªäººä¿¡æ¯è¡¨å•äº‹ä»¶
          const nameInput = document.getElementById('yijing-name');
          const birthdayInput = document.getElementById('yijing-birthday');
          const luckyInput = document.getElementById('yijing-lucky');
          const setBtn = document.getElementById('yijing-setinfo');
          const bloodInput = document.getElementById('yijing-blood');
          if (setBtn) setBtn.onclick = () => {
            customInfo.name = nameInput.value.trim();
            customInfo.birthday = birthdayInput.value;
            customInfo.lucky = luckyInput.value.trim();
            customInfo.blood = bloodInput.value;
            lastInfo = { ...customInfo };
            show();
          };
          // è¾“å…¥å˜åŒ–æ—¶åŠ¨æ€åˆ·æ–°æŒ‰é’®çŠ¶æ€
          [nameInput, birthdayInput, luckyInput, bloodInput].forEach(input => {
            if (input) input.oninput = input.onchange = () => {
              customInfo.name = nameInput.value.trim();
              customInfo.birthday = birthdayInput.value;
              customInfo.lucky = luckyInput.value.trim();
              customInfo.blood = bloodInput.value;
              // åªåˆ·æ–°è¡¨å•éƒ¨åˆ†
              const btn = document.getElementById('yijing-setinfo');
              if (btn) {
                const changed = isInfoChanged();
                btn.style.background = changed ? '#1890ff' : '#ccc';
                btn.style.cursor = changed ? 'pointer' : 'not-allowed';
                btn.disabled = !changed;
              }
            };
          });
          const againBtn = document.getElementById('yijing-again');
          if (againBtn) againBtn.onclick = show;
        }, 100);
      }
      show();
    }

    // MD5å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function md5cycle(x, k) {
      let [a, b, c, d] = x;
      function ff(a, b, c, d, x, s, t) {
        a = (a + ((b & c) | (~b & d)) + x + t) | 0;
        return (((a << s) | (a >>> (32 - s))) + b) | 0;
      }
      function gg(a, b, c, d, x, s, t) {
        a = (a + ((b & d) | (c & ~d)) + x + t) | 0;
        return (((a << s) | (a >>> (32 - s))) + b) | 0;
      }
      function hh(a, b, c, d, x, s, t) {
        a = (a + (b ^ c ^ d) + x + t) | 0;
        return (((a << s) | (a >>> (32 - s))) + b) | 0;
      }
      function ii(a, b, c, d, x, s, t) {
        a = (a + (c ^ (b | ~d)) + x + t) | 0;
        return (((a << s) | (a >>> (32 - s))) + b) | 0;
      }
      a = ff(a, b, c, d, k[0], 7, -680876936);
      d = ff(d, a, b, c, k[1], 12, -389564586);
      c = ff(c, d, a, b, k[2], 17, 606105819);
      b = ff(b, c, d, a, k[3], 22, -1044525330);
      a = ff(a, b, c, d, k[4], 7, -176418897);
      d = ff(d, a, b, c, k[5], 12, 1200080426);
      c = ff(c, d, a, b, k[6], 17, -1473231341);
      b = ff(b, c, d, a, k[7], 22, -45705983);
      a = ff(a, b, c, d, k[8], 7, 1770035416);
      d = ff(d, a, b, c, k[9], 12, -1958414417);
      c = ff(c, d, a, b, k[10], 17, -42063);
      b = ff(b, c, d, a, k[11], 22, -1990404162);
      a = ff(a, b, c, d, k[12], 7, 1804603682);
      d = ff(d, a, b, c, k[13], 12, -40341101);
      c = ff(c, d, a, b, k[14], 17, -1502002290);
      b = ff(b, c, d, a, k[15], 22, 1236535329);
      a = gg(a, b, c, d, k[1], 5, -165796510);
      d = gg(d, a, b, c, k[6], 9, -1069501632);
      c = gg(c, d, a, b, k[11], 14, 643717713);
      b = gg(b, c, d, a, k[0], 20, -373897302);
      a = gg(a, b, c, d, k[5], 5, -701558691);
      d = gg(d, a, b, c, k[10], 9, 38016083);
      c = gg(c, d, a, b, k[15], 14, -660478335);
      b = gg(b, c, d, a, k[4], 20, -405537848);
      a = gg(a, b, c, d, k[9], 5, 568446438);
      d = gg(d, a, b, c, k[14], 9, -1019803690);
      c = gg(c, d, a, b, k[3], 14, -187363961);
      b = gg(b, c, d, a, k[8], 20, 1163531501);
      a = gg(a, b, c, d, k[13], 5, -1444681467);
      d = gg(d, a, b, c, k[2], 9, -51403784);
      c = gg(c, d, a, b, k[7], 14, 1735328473);
      b = gg(b, c, d, a, k[12], 20, -1926607734);
      a = hh(a, b, c, d, k[5], 4, -378558);
      d = hh(d, a, b, c, k[8], 11, -2022574463);
      c = hh(c, d, a, b, k[11], 16, 1839030562);
      b = hh(b, c, d, a, k[14], 23, -35309556);
      a = hh(a, b, c, d, k[1], 4, -1530992060);
      d = hh(d, a, b, c, k[4], 11, 1272893353);
      c = hh(c, d, a, b, k[7], 16, -155497632);
      b = hh(b, c, d, a, k[10], 23, -1094730640);
      a = hh(a, b, c, d, k[13], 4, 681279174);
      d = hh(d, a, b, c, k[0], 11, -358537222);
      c = hh(c, d, a, b, k[3], 16, -722521979);
      b = hh(b, c, d, a, k[6], 23, 76029189);
      a = hh(a, b, c, d, k[9], 4, -640364487);
      d = hh(d, a, b, c, k[12], 11, -421815835);
      c = hh(c, d, a, b, k[15], 16, 530742520);
      b = hh(b, c, d, a, k[2], 23, -995338651);
      a = ii(a, b, c, d, k[0], 6, -198630844);
      d = ii(d, a, b, c, k[7], 10, 1126891415);
      c = ii(c, d, a, b, k[14], 15, -1416354905);
      b = ii(b, c, d, a, k[5], 21, -57434055);
      a = ii(a, b, c, d, k[12], 6, 1700485571);
      d = ii(d, a, b, c, k[3], 10, -1894986606);
      c = ii(c, d, a, b, k[10], 15, -1051523);
      b = ii(b, c, d, a, k[1], 21, -2054922799);
      a = ii(a, b, c, d, k[8], 6, 1873313359);
      d = ii(d, a, b, c, k[15], 10, -30611744);
      c = ii(c, d, a, b, k[6], 15, -1560198380);
      b = ii(b, c, d, a, k[13], 21, 1309151649);
      a = ii(a, b, c, d, k[4], 6, -145523070);
      d = ii(d, a, b, c, k[11], 10, -1120210379);
      c = ii(c, d, a, b, k[2], 15, 718787259);
      b = ii(b, c, d, a, k[9], 21, -343485551);
      x[0] = (a + x[0]) | 0;
      x[1] = (b + x[1]) | 0;
      x[2] = (c + x[2]) | 0;
      x[3] = (d + x[3]) | 0;
    }
    function md5blk(s) {
      let md5blks = [], i;
      for (i = 0; i < 64; i += 4) {
        md5blks[i >> 2] =
          s.charCodeAt(i) +
          (s.charCodeAt(i + 1) << 8) +
          (s.charCodeAt(i + 2) << 16) +
          (s.charCodeAt(i + 3) << 24);
      }
      return md5blks;
    }
    function md51(s) {
      let n = s.length,
        state = [1732584193, -271733879, -1732584194, 271733878],
        i;
      for (i = 64; i <= n; i += 64) {
        md5cycle(state, md5blk(s.substring(i - 64, i)));
      }
      s = s.substring(i - 64);
      let tail = Array(16).fill(0);
      for (i = 0; i < s.length; i++) tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
      tail[i >> 2] |= 0x80 << ((i % 4) << 3);
      if (i > 55) {
        md5cycle(state, tail);
        tail = Array(16).fill(0);
      }
      tail[14] = n * 8;
      md5cycle(state, tail);
      return state;
    }
    function rhex(n) {
      let s = '', j = 0;
      for (; j < 4; j++) s += ((n >> (j * 8 + 4)) & 0x0f).toString(16) + ((n >> (j * 8)) & 0x0f).toString(16);
      return s;
    }
    function md5(s) {
      return md51(s).map(rhex).join('');
    }
    // ç§å­éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆmulberry32ï¼‰
    function mulberry32(seed) {
      return function() {
        seed |= 0;
        seed = (seed + 0x6D2B79F5) | 0;
        let t = Math.imul(seed ^ (seed >>> 15), 1 | seed);
        t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    // ç„ä¹‹åˆç„å¼¹çª—
    function showXuanDialog() {
      const cfg = configs[mode];
      let wish = '';
      function genNumbers(seedStr, count) {
        // ç”¨MD5å‰8ä½è½¬ä¸ºæ•´æ•°åšç§å­
        const md5str = md5(seedStr);
        let seed = parseInt(md5str.slice(0, 8), 16);
        let rand = mulberry32(seed);
        let numbers = [];
        for (let i = 0; i < count; i++) {
          // æ¯ç»„ç”¨ä¸åŒseedï¼ˆMD5+åºå·ï¼‰
          let subSeed = parseInt(md5(md5str + '_' + i).slice(0, 8), 16);
          let subRand = mulberry32(subSeed);
          // çº¢çƒ
          let reds = [];
          let arr = Array.from({length: cfg.red.max}, (_,i)=>i+1);
          for (let j = arr.length - 1; j > 0; j--) {
            const k = Math.floor(subRand() * (j + 1));
            [arr[j], arr[k]] = [arr[k], arr[j]];
          }
          reds = arr.slice(0, cfg.red.count).sort((a,b)=>a-b);
          // è“çƒ
          let blues = [];
          let arrb = Array.from({length: cfg.blue.max}, (_,i)=>i+1);
          for (let j = arrb.length - 1; j > 0; j--) {
            const k = Math.floor(subRand() * (j + 1));
            [arrb[j], arrb[k]] = [arrb[k], arrb[j]];
          }
          blues = arrb.slice(0, cfg.blue.count).sort((a,b)=>a-b);
          numbers.push({red: reds, blue: blues});
        }
        return numbers;
      }
      function render() {
        let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:10px;color:#fff;'>ç„ä¹‹åˆç„</div>`;
        html += `<div style='font-size:15px;color:#bbb;margin-bottom:10px;'>è¾“å…¥ä½ çš„å¿ƒæ„¿ï¼Œç³»ç»Ÿå°†ç”¨ç¥ç§˜ç®—æ³•ï¼ˆMD5+æ¤­åœ†æ›²çº¿åŠ å¯†ï¼‰ä¸ºä½ ç”Ÿæˆ5ç»„å¯èƒ½ä¸­å¥–å·ç ã€‚<br>åŒä¸€å¿ƒæ„¿æ¯æ¬¡ç»“æœç›¸åŒï¼Œæ¢å¿ƒæ„¿å†è¯•è¯•ï¼</div>`;
        html += `<div style='margin-bottom:12px;'><input id='xuan-wish' type='text' value='${wish||''}' placeholder='è¯·è¾“å…¥ä½ çš„å¿ƒæ„¿...' style='width:80%;padding:6px 10px;border-radius:6px;border:1px solid #444;font-size:16px;background:#222;color:#fff;'></div>`;
        html += `<div style='text-align:right;margin-bottom:10px;'><button id='xuan-gen' style='background:#111;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:15px;cursor:pointer;'>ç”Ÿæˆå·ç </button></div>`;
        if (wish) {
          const nums = genNumbers(wish, 5);
          html += `<div style='margin-top:6px;'>`;
          nums.forEach((num, idx) => {
            let redHtml = num.red.map(n=>`<span style='color:#ffd700;font-weight:bold;font-size:15px;background:#222;padding:1px 4px;border-radius:5px;margin-right:1px;'>${n<10?'0'+n:n}</span>`).join(' ');
            let blueHtml = num.blue.map(n=>`<span style='color:#00eaff;font-weight:bold;font-size:15px;background:#222;padding:1px 4px;border-radius:5px;margin-right:1px;'>${n<10?'0'+n:n}</span>`).join(' ');
            html += `<div style='margin:4px 0 0 0;padding:5px 8px;border-radius:7px;background:linear-gradient(90deg,#111,#333);color:#fff;box-shadow:0 1px 4px #0004;display:flex;align-items:center;min-height:28px;'>`;
            html += `<span style='font-size:15px;font-weight:bold;margin-right:10px;color:#ffd700;'>NO.${idx+1}</span> <span style='font-size:15px;'>${redHtml} + ${blueHtml}</span>`;
            html += `</div>`;
          });
          html += `</div>`;
        }
        html += `<div style='font-size:13px;color:#888;margin-top:10px;'>ä»…ä¾›å¨±ä¹ï¼Œç¥å›å¿ƒæƒ³äº‹æˆï¼</div>`;
        html += `<div style='text-align:right;'><button id='xuan-close' style='background:#444;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:15px;cursor:pointer;margin-top:10px;'>å…³é—­</button></div>`;
        // å¼¹çª—
        const old = document.getElementById('test-modal');
        if (old) old.remove();
        const modal = document.createElement('div');
        modal.id = 'test-modal';
        modal.style.position = 'fixed';
        modal.style.left = '0';
        modal.style.top = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.7)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '9999';
        const box = document.createElement('div');
        box.style.background = '#111';
        box.style.borderRadius = '12px';
        box.style.padding = '18px 10px 12px 10px';
        box.style.minWidth = '260px';
        box.style.maxWidth = '90vw';
        box.style.boxShadow = '0 2px 12px #0008';
        box.style.fontSize = '15px';
        box.style.lineHeight = '1.7';
        box.innerHTML = html;
        modal.appendChild(box);
        document.body.appendChild(modal);
        setTimeout(()=>{
          document.getElementById('xuan-gen').onclick = () => {
            wish = document.getElementById('xuan-wish').value.trim();
            render();
          };
          document.getElementById('xuan-wish').onkeydown = e => {
            if (e.key === 'Enter') {
              wish = document.getElementById('xuan-wish').value.trim();
              render();
            }
          };
          document.getElementById('xuan-close').onclick = () => {
            modal.remove();
          };
        }, 100);
      }
      render();
    }

    renderGame();

   

    // è®¾ç½®åŠ¨æ€æ ‡é¢˜å’Œä¸»æ ‡é¢˜
    function setDynamicTitle() {
      var userName = (window.YIJING_USER_INFO && window.YIJING_USER_INFO.name) ? window.YIJING_USER_INFO.name : '';
      var titleText = userName ? (userName + 'çš„å½©ç¥¨å¤§ç©å®¶') : 'å½©ç¥¨å¤§ç©å®¶';
      // titleæ ‡ç­¾ä¸­åå­—ç”¨é‡‘è‰²æ— æ³•ç›´æ¥é«˜äº®ï¼Œä½†å¯ä»¥åŠ ç‰¹æ®Šç¬¦å·åŒºåˆ†
      document.title = userName ? ('â˜…' + userName + 'â˜…çš„å½©ç¥¨å¤§ç©å®¶') : 'å½©ç¥¨å¤§ç©å®¶';
      var h1 = document.querySelector('.container h1');
      if (h1) {
        if (userName) {
          h1.innerHTML = '<span style="font-size:1.2em;margin-right:10px;">ğŸ¯</span><span style="color:#faad14;font-weight:bold;">' + userName + '</span>çš„å½©ç¥¨å¤§ç©å®¶';
        } else {
          h1.innerHTML = '<span style="font-size:1.2em;margin-right:10px;">ğŸ¯</span>å½©ç¥¨å¤§ç©å®¶';
        }
      }
    }
    setDynamicTitle();

    // å¦‚æœç”¨æˆ·ä¿¡æ¯æœ‰å˜åŠ¨ï¼ŒåŠ¨æ€åˆ·æ–°æ ‡é¢˜
    window.YIJING_USER_INFO = {
      name: 'é¡¾é‡‘',
      birthday: '1981-11-06',
      lucky: '23',
      blood: 'A'
    };
    setDynamicTitle();

    function syncUserNumbers(cfg) {
      if (userNumbers.length > betCount) {
        userNumbers = userNumbers.slice(0, betCount);
      } else if (userNumbers.length < betCount) {
        for (let i = userNumbers.length; i < betCount; i++) {
          userNumbers.push({
            red: randomBalls(cfg.red.max, cfg.red.count),
            blue: randomBalls(cfg.blue.max, cfg.blue.count)
          });
        }
      }
    }
  })();
  </script>
</body>
</html> 